# 计算机网络

- **参考资料**
  [《王道计算机网络》学习笔记总目录+思维导图](https://bithachi.blog.csdn.net/article/details/104722679)

- [计算机网络学习笔记](https://www.yuque.com/gaoyanchen/ap6pnr)

## 第 1 章 计算机网络体系结构

### 1.1 计算机网络概述

- 计算机网络是一个将**分散**的(地理位置不同的)、**具有独立功能**的计算机系统，通过**通信设备**(路由等)与**传输介质(**光纤等)连接起来，由功能完善的**软件**实现**资源共享和信息传递**的系统。


#### 1.1.1 计算机网络的组成

- 从组成部分来看
  - 一个完整的计算机网络主要由**硬件、软件和协议**三大部分组成，缺一不可。
  - 硬件主要由**主机**(也称端系统)，**传输介质**(如双绞线、光纤)、**通信设备**(如路由、交换机等)和**通信处理机**(如网卡)等组成。
  - 软件主要包括各种实现资源共享的软件和方便用户使用的各种工具软件(如网络操作系统、邮件收发程序、FTP程序、聊天程序等)。
  - **协议是计算机网络的核心，协议规定了网络传输数据时所遵循的规范。**就如同我们现实生活中的法律一样，网络世界也必须遵循一定的规则。
- 从工作方式来看
  - 计算机网络(主要指Internet)可分为**边缘部分**和**核心部分**。
  - 边缘部分由所有连接到因特网上、供用户直接使用的主机组成，用来进行通信(如传输数据、音频或视频)和资源共享。
  - 核心部分由大量的网络和连接这些网络的路由器组成，它为边缘部分提供连通性和交换服务。
- 从功能组成来看
  - 计算机网络由**通信子网**和**资源子网**组成
  - **通信子网由各种传输介质、通信设备和相应的网络协议组成**，它使网络具有数据传输、交换、控制和存储的能力，**实现计算机之间的数据传输**。
    - 通信子网对应于低三层（物理层、数据链路层、网络层）。
  - **资源子网是实现资源共享功能的设备及其软件的集合**，向网络用户提供共享其他计算机上的硬件资源、软件资源和数据资源的服务。
    - 资源子网对应于高三层（会话层、表示层、应用层）。

#### 1.1.2 计算机网络的功能

- 数据通信
  - 路由选择
- 资源共享
- 提高可靠性
  - 差错控制
  - 拥塞控制
  - 流量控制

#### 1.1.3 计算机网络的分类

- **按分布范围分类**
  - 广域网（WAN）。也称远程网。关于网提供长距离通信，通常是几十千米到几千千米的区域，比如跨国通信。连接关于网的各结点交换机的链路一般都是高速链路，具有较大的通信容量。
  - 城域网（MAN）。覆盖范围跨越几个街区甚至整个城市，覆盖范围约5~50km，城域网大多采用以太网技术，因此有时也常并入局域网的范围进行讨论。
  - 局域网（LAN）。范围几十米到几千米的区域。一般用微机或工作站通过高速线路相连。传统上，局域网使用广播技术，而广域网使用交换技术。
  - 个人区域网（PAN）。覆盖范围大约十米左右。指在个人工作的地方将消费电子设备（如平板电脑、智能手机等）用无线技术连接起来的网络，也常称为无线个人区域网（WPAN）
- **按传输技术分类**
  - 广播式网络。所有联网计算机都共享一个**公共通信信道**。当一台计算机利用公共通信信道发送报文分组时，所有其他计算机都会收听到这个分组。接受到该分组的计算机将通过检查目的地之来决定是否接受该分组。
  - 点对点网络。每条物理线路连接一对计算机。
- **按拓扑结构分类**
  - 网络拓扑结构是指网络总的结点（路由器、主机等）于通信线路（网线）之间的几何关系（如总线形、环形）表示的网路结构，主要指通信子网的拓扑结构。分为四类：
    - 总线形：用单根传输线把计算机连接起来
    - 星形：每个终端或计算机都以单独的线路和中央设备相连
    - 环形：所有计算机接口设备连接成一个环
    - 网状形：一般情况下，每个结点至少有两条路径与其他结点相连，多用于广域网
- 按使用者分类
  - 公用网（Public Network）。也称公众网。指电信公司出资建造的大型网络。
  - 专用网（Private Network）。指某个部门为满足本单位特殊业务需要而建造的网络。这种网络不向本单位以外人提供服务。如铁路、典礼、军队等部门专用网络。
- **按交换技术分类**
  - **电路交换网络**。在源结点和目的结点之间建立起一条专用的通路用于传输数据，包括建立连接（占用通信资源）、传输数据（一直占用通信资源）和断开连接（释放通信资源）三个阶段。最典型的电路交换网是传统电话网络。该类网络的特点是整个报文的比特流连续的从源点直达终点，好像在一条管道中传送。
  - **报文交换网络**。也称存储-转发网络。用户数据加上源地址、目的地址、校验码等辅助信息，然后封装成报文、**这个报文传送到相邻结点，全部存储后，再转发给下一个结点**，重复这一过程直到到达目的结点，每个报文可以单独选择到达目的结点的路径。
  - **分组交换网络**。也称包交换网络。其原理是**将数据分成较短的固定长度的数据块**，在每个数据块中加上目的地址、源地址等辅助信息组成分组（包），以储存-转发方式传输。

![](img\三种交换方式的比较.png)
- 按传输介质分类
  - 传输介质可分为有线和无线两大类。
  - 有线网络可分为双绞线网络、同轴电缆网络等。
  - 无线网络可分为蓝牙、微波、无线电等类型。

#### 1.1.4 计算机网络的性能指标

- 速率（数据率、数据传输率、比特率）：连接在计算机网络上的主机在数字信道上传送数据位数的速率。
- 带宽：单位时间内从网络的某一点到另一点所能通过的“最高数据率”。
- 吞吐量：单位时间内通过某个网络（或信道、接口）的数据量。
- 时延：指数据（一个报文或分组）从网络（或链路）的一端传送到另一端所需要的总时间，它由四部分构成：
  - 发送时延：结点将分组的所有比特推向（传输）链路所需要的时间，即从发送分组的第一个比特算起，到该分组的最后一个比特推向传输链路所需要的时间。也称**传输时延**。
    - 发送时延 = 分组长度 / 信道带宽（发送速率）
  - 传播时延：电磁波在信道中传播一定的距离需要花费的时间，即一个比特从链路的一端传播到另一端所需要的时间。
    - 传输时延 = 信道长度 / 电磁波的传播速率
  - 排队时延：分组数据从到达路由器到被处理的等待时间。
  - 处理时延：数据在交换结点为存储转发而进行的一些必要的处理所花费的时间。例如：分析分组的首部、差错检验、路由选择等。
- 往返时延 RTT：从发送方发送数据开始，到收到接收方的确认，总共经历的时间。
- 时延带宽积：指发送端发送的第一个比特即将到达终点时，发送端已经发出了多少个比特。
  - 时延带宽积 = 传播时延 * 信道带宽
  - 又称以比特为单位的链路长度。
- 信道利用率：出某一信道有百分之多少的时间是有数据通过的。
  - 信道利用率 = 有数据通过的时间 / 总时间。

### 1.2 计算机网络体系结构与参考模型

- 为什么要分层？
  - ARPANET 的研制经验表明，对于复杂的计算机网络协议，其结构应该是层次式的。分层的好处：
    - 各层之间相互独立，灵活性好
    - 结构上可以分隔开，易于实现和维护。
    - 能促进标准化工作。


#### 1.2.1 计算机网络的分层结构、协议、服务和接口

- **基本概念**：

  - 实体：第n层中的活动元素称为n层实体。同一层的实体叫对等实体。
  - 协议：**为进行网络中的对等实体数据交换而建立的规则、标准或约定称为网络协议。**【水平】
    - 语法：规定传输数据的格式
    - 语义：规定所要完成的功能
    - 同步：规定各种操作的顺序
  - 接口(服务访问点 SAP)：上层使用下层服务的入口。
    - 数据链路层的SAP是MAC地址。
    - 网络层的SAP是IP地址。
    - 传输层的SAP是端口。
  - 服务：下层为相邻上层提供的功能调用。【垂直】

- SDU 服务数据单元：为完成用户所要求的功能而应传送的数据。
    - PCI 协议控制信息：控制协议操作的信息。
    - PDU 协议数据单元：对等层次之间传送的数据单位。
    - PDU = PCI + SDU

![](img\协议、接口、服务之间的关系.png)

#### 1.2.2 OSI参考模型（应用层、表示层、会话层、传输层、网络层、数据链路层、物理层）

![](img\OSI数据传输图.png)

- 1984年，国际标准化组织（ISO）提出开放系统互连（OSI）参考模型。
- **应用层（Application Layer）**
  - 传输单位：报文。
  - 应用层是OSI模型的最高层，是用户与网络的界面。
  - 主要功能：**为特定类型的网络应用提供访问OSI环境的手段。**
  - 主要协议：FTP、SMTP、HTTP、DNS、RIP、BGP。
- **表示层（Presentation Layer）**
  - 主要功能：**处理两个通信系统中交换信息的表示方式。**
  - 表示层 SAP / PLSAP（Presentation layer Service Access Point）：具体网络应用进程中的用户标识。
  - 为了使不同的数据和信息之间能够互相交换，表示层采用抽象的标准方法定义数据结构。
  - 主要协议：JPEG、ASCII
- **会话层（Session Layer）**
  - 主要功能：**允许不同主机上的各个进程进行会话。**
  - 会话层 SAP /  SLSAP（Session layer Service Access Point）：网络应用会话进程。
- **传输层（Transport Layer）**
  - 传输单位：**报文段（TCP）**或**用户数据报（UDP）。**
  - 传输层 SAP / TSAP（Transport layer Service Access Point）：端口。
  - 主要功能：**传输层负责主机中两个进程之间的通信**，为**端到端**连接提供可靠的传输服务。
    - 差错控制
    - 流量控制
    - 拥塞控制
    - 服务质量
  - 主要协议：TCP、UDP
- **网络层（Network Layer）**
  - 传输单位：**数据包（数据报）**。
  - 因为因特网的主要网络层协议是无连接的网际协议（Internet Protocol，IP）和许多路由选择协议，因此因特网的网络层也称**网际层**或**IP层**。
  - 网络层 SAP / NSAP（Network layer Service Access Point）：IP地址。
  - 主要功能：**将数据包（数据报）从源端路由到接收方。**
    - 路由选择
    - 拥塞控制
    - 服务质量
    - 网络互联
    - 流量控制
    - 差错控制
  - 主要协议：IP、ICMP、ARP、OSPF
- **数据链路层（Data Link Layer）**
  - 传输单位：**帧**。
  - 数据链路层 SAP / DLSAP（Data Link Control layer Service Access Point）：MAC地址。
  - 主要功能：
    - 为网络层提供服务
    - 成帧：将网络层传下来数据包组装成帧。
    - 差错控制
    - 流量控制
    - 访问控制
  - 主要协议：Ethernet、PPP
- **物理层（Physical Layer）**
  - 传输单位：比特。
  - 物理层 SAP / PSAP (Physical layer Service Access Point）：网络通信中设备的具体物理接口。
  - 主要功能：**实现比特流的透明传输。**
    - 定义接口特性
    - 定义通信方式：单工、半双工、双工
    - 定义传输速率
    - 比特同步
    - 比特编码

#### 1.2.3 TCP/IP参考模型（应用层、传输层、网际层、网络接口层）

![](img\TCP-IP、OSI、五层参考模型结构图.png)

- TCP/IP与OSI 的相同点：
  - 都分层
  - 基于独立的协议栈的概念
  - 可以实现异构网络互联
- TCP/IP与OSI 的不同点
  - 0SI 定义三点：服务、协议、接口。
  - 0SI 先出现，参考模型先于协议发明，不偏向特定协议，TCP/IP 则相反。
  - TCP/IP 设计之初就考虑到异构网互联问题，将 IP 作为重要层次。

#### 1.2.4 五层参考模型（应用层、传输层、网络层、数据链路层、物理层）

![](img\五层参考模型数据封装与解封装（数据传输）.png)

### 1.3 计算机网络体系结构总结

- **端到端通信和点到点通信有什么区别?**
  - 从本质上说，由物理层、数据链路层和网络层组成的通信子网为主机或路由器等提供点到点的服务，而传输层为网络中的主机提供端到端的通信。
  - 直接相连的结点之间的通信称为点到点通信，它只提供一台机器到另一台机器之间的通信，不涉及程序或进程的概念，同时，**点到点通信并不能保证数据传输的可靠性**，也不能说明源主机与目的主机之间是哪两个进程在通信，这些工作都是由传输层来完成的。
  - 端到端通信建立在点到点通信的基础上，**由一段段的点到点通信信道构成的**，是比点到点通信更高一级的通信方式，以完成应用程序(进程)之间的通信。“端”是指用户程序的端口，端口号标识了应用层中不同的进程。

- 谁应当负责数据传输的可靠性？
  - 一种意见是主张应当像电信网那样，由通信网络负责数据传输的可靠性(因为电信网的发展历史及其技术水平已经证明人们可以将网络设计得相当可靠)。
  - 另一种意见则坚决主张由用户的主机负责数据传输的可靠性，理由是这样可使计算机网络便宣，灵活。
  - 计算机网络的先驱认为，计算机网络和电信网的一个重大区别是终端设备的性能差别很大，于是，他们采用了“**端到端的可靠传输**”策略，即在传输层使用面向连接的TCP协议，这样既能使网络部分价格便宜且灵活可靠，又能保证端到端的可靠传输。

- 计算机网络与分布式计算机系统的区别？
  - 分布式系统：
    - 整个系统中的各个计算机对用户都是透明的。
  - 计算机网络：
    - 需要显式地与其他计算机进行通信。

## 第 2 章 物理层

- 传输单位：比特。
- 主要功能：**实现比特流的透明传输。**
  - 定义接口特性
  - 定义通信方式：单工、半双工、双工
  - 数据传输方式：
    - 若按数据传输的顺序可以分为**并行传输**和**串行传输**；
    - 若按数据传输的同步方式可分为**同步传输**和**异步传输**；
  - 定义传输速率
  - 比特同步
  - 比特编码

### 2.1 通信基础

- 物理层接口特性
  - 机械特性：定义物理连接的特性，规定物理连接时采用的规格、接口形状、引线数目、引脚数量和排列情况。
  - 电气特性：规定传输二进制位时，线路上信号的电压范围、阻抗匹配、传输速率和距离限制等。
  - 功能特性：指明某条线上出现的某一电平表示何种意义，接口部件的信号线的用途。
  - 规程特性（过程特性）：定义各条物理线路的工作规程和时序关系。
- 数据通信模型

![](D:\学习\计算机网络\img\典型的数据通信模型.png)

- 物理层基本概念（数据、信号、码元 、信源、信道、信宿 、速率、波特、带宽）
  - 数据：传送信息的实体，通常是有意义的符号序列。
  - 信号：数据的电气/电磁的表现，是数据在传输过程中的存在形式。
    - 数字信号：参数取值是离散的。
    - 模拟信号：参数取值是连续的。
  - 信源：产生和发送数据的源头。
  - 信宿：接收数据的终点
  - 信道：信号的传输媒介。一般用来表示向某一个方向传送信息的介质，因此一条通信线路往往包含一条发送信道和一条接收信道。
    - 按传输信号分类：
      - 数字信道：传送数字信号（基带信号）
      - 模拟信道：传送模拟信号
    - 按传输介质分类：
      - 无线信道
      - 有线信道
  - **码元**：代表不同离散数值的固定时长的信号波形（数字脉冲）。
    - 码元是数字通信中数字信号的计量单位，这个时长内的信号称为k进制码元，而该时长称为码元宽度。
    - 当码元的离散状态有M个时(M大于2)，此时码元为M进制码元。
  - 速率：也叫数据率，是指数据的传输速率，表示单位时间内传输的数据量。可以用码元传输速率和信息传输速率表示。
    - **码元传输速率**：别名码元速率、波形速率、调制速率、符号速率等，它表示**单位时间内数字通信系统所传输的码元个数**（也可称为脉冲个数或信号变化的次数），单位是**波特(Baud)**。
      - 1波特表示数字通信系统每秒传输一个码元。这里的码元可以是多进制的，也可以是二进制的，但码元速率与进制数无关。
    - **信息传输速率**：别名信息速率、比特率等，表示单位时间内数字通信系统传输的二进制码元个数（即比特数），单位是**比特/秒(b/s)**。
      - 如果一个码元携带n bit的信息量，则 M Baud 的码元传输速率所对应的信息传输速率为 M * n bit/s。
  - **带宽**：表示在单位时间内从网络中的某一点到另一点所能通过的“最高数据率”，常用来表示网络的通信线路所能传输数据的能力。单位是b/s。
  - 信道带宽：信道能通过的最高频率和最低频率之差。

- 奈氏准则和香农定理
  - 码间串扰：接收端收到的信号波形失去了码元之间清晰界限的现象。
  - **奈氏准则**：在**理想低通(无噪声，带宽受限)**条件下，为了避免码间串扰，极限码元传输速率为 2W Baud，W是信道带宽，单位是Hz。
    - 最大数据速率 = 2W * log2(V)，单位为 b/s。
    - 其中V是信号包含的离散电平数目。
  - **香农定理**：在**带宽受限且有噪声**的信道中，为了不产生误差，信息的数据传输速率有上限值。
    - 最大比特率 = W * log2(1 + S/N)，单位为 b/s。
    - 其中W是信道带宽，单位是Hz，S/N是信噪比，S是信道所传信号的平均功率，N是信道内的高斯噪声功率。
    - 信噪比形式为 10log10(S/N) 时，单位为分贝（dB，decibel）。

- **编码与调制**

  - 数据无论是数字的，还是模拟的，为了传输的目的都必须转变成信号。
  - 把数据变换为模拟信号的过程称为**调制**，把数据变换为数字信号的过程称为**编码**。
  - **基带传输**：将数据比特进行**编码**转换成**基带信号**，再送到**数字信道**上传输。
  - **通道传输**：将基带信号进行**调制**转换成**模拟信号**，再送到**模拟信道**上传输。

- **基带传输的编码方式**

  ![](D:\学习\计算机网络\img\编码与调制.png)

  - 不归零（NZI）编码：高1低0。
  - 反向不归零编码/不归零逆转（NRZI）编码：电平翻转表示0，不变表示1。
  - 曼彻斯特编码：将一个码元分成两个相等的间隔，前一个间隔为低电平后一个间隔为高电平表示码元1。码元0则正好相反。也可以采用相反的规定。
    - 该编码的特点是在每一个码元的中间出现电平跳变，位中间的跳变既作时钟信号（可用于同步），又作数据信号，但它所占的频带宽度是原始的基带宽度的两倍。
    - 每一个码元都被调成两个电平所以数据传输速率只有调制速率的1/2。
  - **差分曼彻斯特编码**：常用于局域网传输，其规则是：若码元为1，则前半个码元的电平与上ー个码元的后半个码元的电平相同。若为0，则相反。
    - 在每个码元的中间，都有一次电平的跳转，可以实现自同步，且抗干扰性强于曼彻斯特编码。

- **基带信号调制为模拟信号**

  - 幅移键控（ASK）：通过两个不同的振幅表示0和1。
  - 频移键控（FSK）：通过不同的频率表示更多的符号。
  - 相移键控（OSK）：通过不同的相位表示更多的符号。
  - 正交调幅（QAM）：通过不同的振幅和相位表示更多的信息。
    - 星座图

- 模拟数据编码为数字信号

  - 抽样
  - 量化
  - 编码

### 2.2 传输介质及物理设备

#### 2.2.1 传输介质及其分类

- 导向性传输介质
  - 双绞线：双绞线是古老、又最常用的传输介质，它由两根采用一定规则并排绞合的、相互绝缘的铜导线组成。绞合可以减少对相邻导线的电磁干扰。
    - 屏蔽双绞线：为了进一步提高抗电磁干扰能力，可在双绞线的外面再加上一个由金属丝编织成的屏蔽层。
  - 同轴电缆：由导体铜质芯线、绝缘层、网状编织屏蔽层和塑料外层构成。
    - 50Ω基带同轴电缆：主要用于传送基带数字信号。
    - 75欧姆宽带同轴电缆：主要用于有线电视系统。
  - 光纤：光纤通信就是利用光导纤维（简称光纤）传递光脉冲来进行通信。有光脉冲表示1，无光脉冲表示0。而可见光的频率大约是 10^8 MHz，因此光纤通信系统的带宽远远大于目前其他各种传输媒体的带宽。
    - 单模光纤：光纤直径减小到只有几个光波波长大小，此时光按直线传播而不会反射。
      - 衰减小，高带宽，远距离、成本高。
    - 多模光纤
      - 低带宽、短距离。
    - 光纤的特点
      - 传输损耗小，中继距离长，对远距离传输特别经济。
      - 抗雷电和电磁干扰性能好。
      - 无串音干扰，保密性好，也不易被窃听或截取数据。
      - 体积小，重量轻。
- 非导向性传输介质
  - 无线电波：较强穿透能力，可传远距离，广泛用于通信领域（如手机通信）。
  - 微波：
    - 地面微波接力通信。
    - 卫星通信。
  - 红外线、激光

#### 2.2.2 物理层设备（中继器、集线器）

- 中继器：
  - 功能：对信号进行再生和还原，对衰减的信号进行放大，保持与原数据相同，以增加信号传输的距离，延长网络的长度。
  - 不隔离冲突域、广播域
- 集线器
  - 本质上就是一个多端口中继器，对信号放大后发到其他所以端口。
  - 功能：对信号进行再生放大转发，对衰减的信号进行放大，接着转发到其他所有（除输入端口外）处于工作状态的端口上，以增加信号传输的距离，延长网络的长度。不具备信号的定向传送能力，是一个共享式设备。
  - 不隔离冲突域、广播域
  - 连载集线器上的工作主机平分带宽。

## 第 3 章 数据链路层

[计算机网络笔记(五)——数据链路层](https://zhuanlan.zhihu.com/p/52665008)

**数据链路层（Data Link Layer）**

- 两个子层：
  - **介质访问控制（Medium Access Control, MAC）子层**：**控制不同用户数据传输中对物理层传输介质的访问**，包括：
    - 数据帧的封装/卸装
    - 帧的寻址和识别
    - 帧的接收与发送
    - 帧的差错控制
    - 介质访问冲突控制等。
  - **逻辑链路控制（Logical Link Control, LLC）子层**：负责数据链路层中的逻辑链路（逻辑链路就是物理层信道中的物理链路，在通过LLC协议作用后形成的虚拟电路）。包括：
    - 逻辑链路的建立和释放
    - 控制信号交换
    - 数据流量控制
    - 解释上层通信协议传来的命令并生产响应
    - 克服数据在传输的过程当中发生的种种问题。如数据发生错误、重复收到相同的数据、接收数据顺序与传送的顺序不一致等。
    - 在LLC子层方面，IEEE 802系列中只制定了一种标准——IEEE 802.2。

- 传输单位：**帧**。
- 目的：在原始的、有差错的物理传输线路的基础上，采取差错检测、差错控制和流量控制等方法，将有差错的物理线路改进成逻辑上的无差错的数据链路，以便向他的上一层网络层提供高质量的服务。
- **主要功能**：将数据从源机器的网络层**透明可靠**地传输到目标机器的网络层。
  - 为网络层提供服务
  - 成帧：将网络层传下来数据包组装成帧。
  - 差错控制
  - 流量控制
  - 访问控制
- 主要协议：Ethernet、PPP

- **物理层和数据链路层**的本质作用都是用来构建网络通信、访问通道，但它们所**建立的通信通道是不一样的**。首先要说明的一点是，在物理层上构建的是**物理链路**，在数据链路层上构建的是**逻辑链路或者数据链路**。
  - **物理链路**是指在物理层设备（包括传输介质、物理接口和收发器等）和相应物理层通信规程作用下形成的物理线路，是永久存在的，且是不可删除的（除非物理拆除）；
  - **逻辑链路**则是通信双方在需要进行数据通信时，在数据链路层设备和相应的通信规程作用下建立的逻辑链路，可以是永远存在的（如局域网中的以太网链路），也可以不是永久存在的（如广域网中的链路），是否永久存在要视具体的数据链路层服务类型而定。

### 3.1 数据链路层的功能

#### 3.1.1 提供给网络层的服务

- 数据链路层提供给网络层的三种服务：
  - 无确认的无连接服务
    - 目标主机不对接收得到的帧进行确认。
    - 不需要建立、释放逻辑连接。
    - 不试图去检测丢帧，也不会去恢复丢失的帧。
    - 适合场景：
      - 错误率很低的场合，此时差错恢复过程留给上层实现。
      - 实时通信
    - 应用：以太网。
  - 有确认的无连接服务
    - 依然不建立逻辑连接，但是发送的每一帧都要单独确认。
    - 如果一个帧在指定时间内没有到达，则重新发送。
    - 应用：802.11（WIFI）。
  - 有确认的有连接服务
    - 源机器和目标机器在传输任何数据之前都要建立一个l连接，连接上发送的每一帧都被编号。
    - 数据链路层确保发出的每个帧都会被接收方接收到，并且只会被接收一次，而且按序接收。
    - 包括三个主要阶段：链路建立、链路保持、链路释放。
    - 使用场景：长距离且不可靠的线路，比如卫星通信、长途电话。
    - 应用：广域网。

#### 3.1.2 成帧

- 封装成帧就是在一段数据的前后部分**添加首部和尾部**，这样就构成了一个帧。接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。

- 帧同步：接收方应当能从接收到的二进制比特流中区分出帧的起始和终止。

- 帧的最大长度受对应的数据链路层协议的 **MTU（最大传输单元）限制**，如以太网数据链路层封装网络层IP包的 MTU 值为 **1500**字节（这是指帧中数据部分，也就是来自网络层整个数据分组，最大不能超过 1500 字节，但不包括帧头和帧尾部分）。

- 同时，帧还有**最小大小限制**，如以太网帧中封装的 IP 包最小值为 **46 字节**，如果封装的 IP 包小于最小帧要求时，就要用一些特殊字符进行填充，以满足对应链路中传输最小帧的限制。

- 组帧的四种方法：

  - 字符计数法：以一个特殊字符代表一个帧的起始，并以一个专门的字段来标识当前帧内字节数的帧同步方法。
    - 出错后将会导致灾难性后果。

  ![](D:\学习\计算机网络\img\字符计数法.png)

  - 字节填充的标志字节法
    - 在每个帧加入一些特殊字节作为帧的开始和结束。
    - 如果原数据出现了特殊字节，则在前面填充一个转义字符来区分。

  ![](D:\学习\计算机网络\img\字节填充的标志字节法.png)

  - （零）比特填充的标志比特法

  ![](D:\学习\计算机网络\img\比特填充标志比特法.png)

  - 违规编码法。
    - 使用违规编码来区分帧的边界，例如曼彻斯特编码中只会出现高-低电平或低-高电平，因此可用高-高或低-低电平表示帧的起始和结束。

#### 3.1.3 差错控制

- 校验码：指能够**发现**或能够**自动纠正错误**的数据编码，也称检错纠错编码。前者称为检错编码，后者称为纠错编码。

- **码字**：一个包含了数据位（m位）和校验位（r位）的 n 位单元称为n位码字。

- **海明距离**：两个码字中不相同的位的个数。

- **编码的海明距离**：合法的码字列表中两个具有最小海明距离的码字之间的海明距离。

- 实现原理：通过加一**冗余码**，来检验或纠错编码。

  - 为了可靠地检测d个错误，需要一个距离为 d+1 的编码方案。
  - 为了纠正 d 个错误，需要一个距离为 2d+1 的编码方案。因为合法码字之间的距离足够远，即使发生了d位错误，结果也还是离他原来的码字最近。

- **检错编码**

  - **奇偶校验码**

    - 实现原理： 在原编码中加一个校验位，则原编码就变成了校验码，它的码距为2，可以检查出奇数位错误，但不能检查出偶数位错误。
    - 奇校验码：整个校验码（信息位+校验位）中1的个数为奇数时，校验码为1。
    - 偶校验码：整个校验码（信息位+校验位）中1的个数为偶数时，校验码为1。

  - **循环冗余校验码（CRC）**

    - 基本思想：校验码中的一种。在K位信息位后拼接R位检验位，组成CRC码，这种编码也称(N,R)码

    - 特点：可以发现错误，定位错误位置，自动纠正错误。可检测出所有奇数位错，所有双比特的错和所有小于、等于校验位长度的突发错

    - 例题： 设生成多项式G(x)=X^3+X^2+1，信息码为 101001，求对应的CRC码 。

      - **信息码左移R位**：发送端将原信息码左移R位，低位补0，得 101001 <u>000</u>
      - **模2除法得余数**

      ![](D:\学习\计算机网络\img\模2除法得余数.png)

      - 得到最后的结果CRC码为：101001 001，然后发送端将CRC码101001 001发送给接收端。
      - 接收端收到CRC码后，用生成的CRC码除以生成多项式G(x)所对应的的二进制数码，若余数为0，则信息码在传输过程中没有产生错误，数据正确。

- **纠错编码**

  - **海明码**

    - 实现原理：在有效信息位中加入几个校验位形成海明码，并把海明码的每一个二进制位分配到几个奇偶校验组中。当某一位出错后，就会引起有关的几个校验位的值发生变化。
    - 特点：可以发现错误，定位错误位置，自动纠正错误。 **可以检测双比特错误，但只能纠正单比特错误**。
    - **确定海明码位数r**
      - 假设每个码字有m个消息位和r个校验位，并且能够纠正所有的单个错误。
      - 对于2^m个合法信息，任何一个消息都对应有n个非法的码字，它们与该消息的距离为1。
      - 因此，每个2^m中的和合法消息需要n+1个位模式来标识它们。由于总共只有2^m个位模式，所以，我们必须有 (n+1)*2^m <= 2^n。
      - 由 n=m+r，上述不等式变成了 (m+r+1) <= 2^r。
    - **确定校验位 Pi 在海明码中的位置**
      - 规定校验位 pi 在海明位号位 2^(i-1) 的位置上

    ![](D:\学习\计算机网络\img\确定校验位 Pi 在海明码中的位置.png)

    - **分组形成校验关系**
      - 每个数据位用多个校验位来检验。
      - 必须满足条件：**被校验数据位的海明码位号 = 校验该数据位的各校验位海明位号之和**，比如校验D3，它的海明位号H6为6，那么校验它的校验位为P3和P2，因为他们的海明位号H4和H2加起来等于6。
      - 校验位不需要再被校验

    ![](D:\学习\计算机网络\img\分组形成校验关系.png)

    - **校验位 Pi 取值**
      - Pi的值 = 第 i 组所有数据位求异或⨁
      - P1=D1⨁D2⨁D4=0
      - P2=D1⨁D3⨁D4=1
      - P3=D2⨁D3⨁D4=0

    ![](D:\学习\计算机网络\img\校验位 Pi 取值.png)

    - 海明码的校验原理
      - 每个校验组分别利用校验位和参与形成该校验位的信息位进行奇偶校验检查，即异或运算⨁，构成k个校验方程。
      - S1=P1⨁D1⨁D2⨁D4
      - S2=P2⨁D1⨁D3⨁D4
      - S3=P3⨁D2⨁D3⨁D4
      - 若S1S2S3=000，则说明无错，否则说明出错。这个数的值就是出错的位置，如S1S2S3=001,表示第1位出错，即H1出错，直接将该位取反就可以达到纠错的目的。

- 关于数据链路层和物理层的编码区别

  - 数据链路层编码和物理层的数据编码与调制不同。
  - 物理层编码针对的是单个比特，解决传输过程中比特的同步等问题，如曼彻斯特编码。
  - 而数据链路层的编码针对的是一组比特，它通过冗余码的技术实现一组二进制比特串在传输过程是否出现了差错。

#### 3.1.4 流量控制——滑动窗口机制

[3.4.1 计算机网络之流量控制（停止-等待协议、滑动窗口、后退N帧协议GBN、选择重传协议SR）、滑动窗口、可靠传输机制](https://blog.csdn.net/weixin_43914604/article/details/104908762)

- 流量控制指在特定的发送方和接收方之间的点到点流量的控制，确保一个快速的发送方不会持续地以超过接收方接收能力的速率传输数据。
- 流量控制的基本方法是由接收方控制发送方发送数据的速率。
- 滑动窗口协议的基本原理就是在任意时刻，发送方都维持了一个连续的允许发送的帧的序号，称为**发送窗口**；同时，接收方也维持了一个连续的允许接收的帧的序号，称为**接收窗口**。
  - 发送窗口和接收窗口的序号的上下界不一定要一样，甚至大小也可以不同。

- 滑动窗口有以下重要特性：
  - 只有接受窗口向前滑动时（同时接受方发送确认帧），发送窗口才有可能（只有发送方收到确认帧才是一定）向前滑动。
  - 从滑动窗口的概念看，停止-等待协议、后退N帧协议和选择重传协议只有在发送窗口大小和接收窗口大小有所差别。
    - 停止-等待协议：发送窗口大小=1，接受窗口大小=1；
    - 后退N帧协议：发送窗口大小>1，接受窗口大小=1；
    - 选择重传协议：发送窗口大小>1，接受窗口大小>1；
  - 当接受窗口的大小为1时，可保证帧的有序接受。

- **停止-等待协议**

  - 动机：传输的帧可能出错，也可能丢失。前者通过校验和检测，后者通过为每一个帧添加一个序号解决。
  - 当发送窗口和接收窗口的大小固定为1时，滑动窗口协议退化为停等协议（stop-and-wait）。
  - 该协议规定发送方每发送一帧后就要停下来，等待接收方已正确接收的**确认（acknowledgement）**返回后才能继续发送下一帧。
  - 由于接收方需要判断接收到的帧是新发的帧还是重新发送的帧，因此发送方要为每一个帧加一个**序号**。
  - 由于停等协议规定只有一帧完全发送成功后才能发送新的帧，因而**只用一比特来编号**就够了。

  ![](D:\学习\计算机网络\img\停止-等待协议.png)
  - 信道利用率 = 发生时间/发送周期 = T_D / (T_D + RTT + T_A)，其中 T_D 为发送时延，T_A 为接收时延。

- **多帧滑动窗口与后退N帧协议（GBN）**

  - 动机：停等协议要为每一个帧进行确认后才继续发送下一帧，大大降低了信道利用率。
  - 后退n协议中，发送方在发完一个数据帧后，不停下来等待应答帧，而是连续发送若干个数据帧，即使在连续发送过程中收到了接收方发来的应答帧，也可以继续发送。
  - **发送方在每发送完一个数据帧时都要设置超时定时器**。只要在所设置的超时时间内仍未收到确认帧，就要**重发出错帧及其后的N帧**。
    - 由此可见，若传输信道的传输质量很差因而误码率较大时，连续测协议不一定优于停止等待协议。此协议中的发送窗口的大小为k，接收窗口仍是1。
  - GBN协议中，对n号帧的确认采用**累积确认**的方式，标明接收方已经收到n号帧和它之前的全部帧。
  - 接收方只按序接收帧，不按序的帧直接丢弃。
  - 程序流程：
    - 上层要发送数据时，**发送方先检查下一个可用于该帧的序号**：
      - 如果序号位于发送窗口内，则产生一个帧并将其发送，并**启动超时计时器**；
      - 否则，发送方只需将数据返回给上层，暗示上层窗口已满。上层等一会再发送。 ( 实际实现中，发送方可以缓存这些数据，窗口不满时再发送帧）。
    - 接收方接收到帧后，检查帧的序号：
      - 如果正确收到 n 号帧，并且按序，那么接收方为该帧发送一个ACK，并向前移动滑动窗口。
      - 否则丢弃该帧，并且为最近按序接收的帧重新发送ACK。接收方无需缓存任何失序帧，只需要维护下一个按序接收的帧的序号。
    - 如果发送方收到ACK，更新发送窗口，将被确认的帧标记为已接收。如果该帧序号是窗口的下界，则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧。
    - 如果发送方的计时器超时，发送方重传所有已发送但未被确认的帧，并重启计时器。

  ![](D:\学习\计算机网络\img\GBN传输过程.png)
  - **GBN滑动窗口的限制**
    - 发送窗口的大小 W_T 应满足：1 <= W_T <= 2^n - 1。其中 n 为编号的比特数。下面说明为什么上界不是 2^n。
      - 假设 n=3，即 MAX_SEQ = 7，如果发送方可以发送 2^3 = 8 个帧。
      - 接收方收到8个帧后将7号帧的捎带确认返回给发送方。
      - 发送方发送另外8个帧，序号依旧是 0- 7.
      - 发送方再次接收到7号帧的捎带确认.
      - 现在无法判断第二批的8个帧全部成功到达了，还是全部丢失了。因此，上界应是2^n - 1。
    - 接收窗口大小为1。
  - 缺陷：重传时必须把原来已经正确传送的数据帧重传，使传送效率降低。

- **多帧滑动窗口与选择重传协议（SR）**

  - 动机：如果信道的错误率很高，GBN协议将浪费大量的带宽。由此诞生了SR（SELECTICE REPEAT）。
  - SR工作原理：当接收方发现某帧出错后，其后继续送来的正确的帧虽然不能立即递交给接收方的高层，但接收方仍可收下来，存放在一个缓冲区中，同时要求发送方重新传送出错的那一帧。一旦收到重新传来的帧后，就可以将已存于缓冲区中的其余帧一并按正确的顺序递交上一层。
  - 程序流程：
    - 上层要发送数据时，**发送方先检查下一个可用于该帧的序号**：
      - 如果序号位于发送窗口内，则产生一个帧并将其发送，并**启动超时计时器**；
      - 否则，发送方只需将数据返回给上层，暗示上层窗口已满。上层等一会再发送。 ( 实际实现中，发送方可以缓存这些数据，窗口不满时再发送帧）。
    - 接收方接收到帧后，检查帧的序号是否是接收窗口的下界n：
      - 如果正确接收到按序的n号帧，发送包含该帧序号的ACK，并向前移动接收窗口。
      - 如果帧序号<n，则丢弃该帧。
      - 如果帧序号>n，则缓存该帧，并发送包含该帧序号的ACK。
    - 如果发送方收到ACK，更新发送窗口，将被确认的帧标记为已接收。如果该帧序号是窗口的下界，则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧。
    - 如果计时器超时，发送方重传所有已发送但未被确认的帧，并重启计时器。

  ![](D:\学习\计算机网络\img\SR传输过程.png)

  - **SR滑动窗口的大小限制**
    - 0 <= W_T = W_R <= 2^(n-1)，其中n为序号的比特数。
    - 这是因为要保证滑动之后的新窗口与老窗口的序号没有重叠，所以窗口的最大尺寸不能超过序号空间的一半。

### 3.2 介质访问控制（Medium Access Control, MAC）子层

- 主要功能：**控制不同用户数据传输中对物理层传输介质的访问**，包括：

  - 数据帧的封装/卸装
  - 帧的寻址和识别
  - 帧的接收与发送
  - 帧的差错控制
  - 介质访问冲突控制等。

- **数据帧的发送方式主要有三种**：

  - **单播**：**指从单一的源端发送到单一的目的端。**
    - 单播帧中的目的MAC地址标识了目的端。
    - **单播MAC地址的第8个比特为0**。
    - **冲突域**：同一时间只能有一台设备发送信息的范围。共享式网络中，不同的主机同时发送数据时，就会产生信号冲突的问题，这时的共享网络就是一个**冲突域**。
    - 在**冲突域**中，所有主机都能收到源主机发送的单播帧，但是其他主机发现目的地址与本地MAC地址不一致后会丢弃收到的帧，只有真正的目的主机才会接收并处理收到的帧。
  - **组播**：主机侦听特定组播地址，接收并处理目的MAC地址为该组播MAC地址的帧。
    - **组播MAC地址的第8个比特为1**。
  - **广播**：**表示帧从单一的源发送到共享以太网上的所有主机**。
    - 广播帧的目的MAC地址为十六进制的**FF:FF:FF:FF:FF:FF**。
    - **广播域**：站点发出一个广播信号后能接收到这个信号的范围。通常来说一个局域网就是一个广播域。

- **数据帧接收方式**

  - 帧从主机的物理接口发送出来后，通过传输介质传输到目的端。共享网络中，这个帧可能到达多个主机。
  - 主机**检查帧头中的目的MAC地址**，如果目的MAC地址不是本机MAC地址，也不是本机侦听的组播或广播MAC地址，则主机会**丢弃**收到的帧。
  - 如果**目的MAC地址是本机MAC地址**，则**接收该帧**，检查帧校验序列（FCS）字段，并与本机计算的值对比来确定帧在传输过程中是否保持了完整性。
  - 如果帧的FCS值与本机计算的值不同，主机会认为帧已被破坏，并会**丢弃该帧**。
  - 如果该帧通过了FCS校验，则主机会根据帧头部中的Type字段来确定将帧**发送给上层哪个协议处理**。如果Type字段的值为0x0800，表明该帧需要发送到IP协议上处理。**在发送给IP协议之前，帧的头部和尾部会被剥掉**。

- **多路复用技术**：**把多个信号组合在一条物理信道上进行传输**，使得多个计算机或终端设备**共享信道资源**，提高信道利用率。

- **介质访问控制（MAC，medium access control）：解决共用信道的使用产生竞争时，如何分配信道的使用权问题**。

  - 静态划分信道（信道划分介质访问控制）：将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，把时域和频域资源合理地分配给网络上的设备。

    - **频分多路复用（Frequency-division multiplexing，FDM）**：载波带宽被划分为多种不同频带的子信道，每个子信道可以并行传送一路信号的一种多路复用技术。

    - **时分多路复用（Time-Division Multiplexing，TDM）**：将时间划分为一段段等长的时分复用帧（TDM帧）。每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙，所有用户轮流占用信道。

      - 统计时分复用（Statistical Time Division Multiplexing）是一种根据用户实际需要动态分配线路资源的时分复用方法。

    - **波分多路复用（wavelength-division multiplexing, WDM）**：就是光的频分多路复用，在一根光纤中传输多种不同波长（频率）的光信号，由于波长（频率）不同，所以各路光信号互不干扰，最后再用波长分解复用器将各路波长分解出来。

    - **码分多路复用 （ code oivision Multiple, CDM）**

      - 码分多址（code Division Multiple Access , CDMA ）是码分复用的一种方式，其原理是每比特时间被分成 m 个更短的时间槽，称为**码片（ Chip )**，通常情况下每比特有 64 或 128 个码片。
      - 每个站点被指定一个唯一的 m 位码片序列。
      - 发送 1时，站点发送 m bit 码片序列；发送`0` 时，站点发送 m bit 码片序列的反码。
      - 当两个或多个站点同时发送时，各路数据在信道中线性相加。
      - 为从信道中分离出各路信号，要求各个站点的码片序列相互正交。

      ![](D:\学习\计算机网络\img\码分多路复用.png)

    - **静态划分信道的缺陷**：不适合突发性的流量。

  - **动态划分信道**：所有用户可随机发送信息，发送时占所有带宽。

    - **轮询访问介质访问控制**：在轮询访问中，用户不能随机地发送信息，而要通过一个集中控制的监控站，以循环方式轮询每个结点，再决定信道的分配。当某结点使用信道时，其他结点都不能使用信道。

      - 轮询协议：
        - 轮询协议要求节点中有一个被指定为主节点，其余节点是从属节点。
        - 主节点以循环的方式轮询每一个从属节点，“邀请”从属节点发送数据（实际上是向从属节点发送一个报文，告诉从属节点可以发送帧以及可以传输帧的最大数量），只有被主节点“邀请”的从节点可以发送数据，没有被“邀请”的节点不能发送，只能等待被轮询。
        - 如果一个节点要发送的数据很多，它不会一直发送到结束，它发送到最大数据帧就是结束，主节点开始轮询下一个节点，等再次轮询到它时才能继续发送。即如果从节点要发送的数据很多时，它不是一次性发送结束的。
      - **令牌传递协议**
        - 应用于令牌环网(物理星型拓扑，逻辑环形拓扑)。
        - 采用令牌传送方式的网络常用于负载较重、通信量较大的网络中。
        - 令牌传递又称“标记传送”，局部网数据送取的一种控制方法，多用于环形网。
        - 令牌由专用的信息块组成，典型的令牌由连续的8位“1”组成。当网络所有节点都空闲时，令牌就从一个节点传送到下一个节点。
        - 当某一节点要求发送信息时，它必须获得令牌并在发送之前把它从网络上取走。一旦传送完数据，就把令牌转送给下一个节点，每个节点都具备有发送/接收令牌的装置。
        - 使用这种传送方法决不会发生碰撞，这是因为在某一瞬间只有一个节点有可能传送数据。最大的问题是令牌在传送过程中丢失或受到破坏，从而使节点找不到令牌从而无法传送信息。
        - 程序流程：
          1. 网络空闲时，环路中只有令牌帧在循环传递。
          2. 令牌传递到有数据要发送的站点处时，该站点就修改令牌中的一个标志位，并在令牌中附加自己需要传输的数据，将令牌变成一个数据帧，然后将这个数据帧发送出去。
          3. 数据帧沿着环路传输，接收到的站点一边转发数据，一边查看幀的目的地址。如果目的地址和自己的地址相同，那么接收站就复制该数据帧以便进一步处理。
          4. 数据帧沿着环路传输，直到到达该帧的源站点，源站点接收到自己发出去的数据帧后便不再进行转发。同时，发送方可以通过检验返回的数据帧来查看数据传输过程中是否有错，若有错则重传该帧。
          5. 源站点传送完数据后，重新产生一个令牌，并将令牌传递给下一个站点，以交出对媒体的访问权限。
        - 缺陷：
          - 令牌开销
          - 等待延迟
          - 单点故障

    - **随机访问介质访问控制**

      - 动机：信道划分介质访问控制在应对突发性流量时表现糟糕。

      - 优点：

        - 负载轻时共享信道效率高，单个结点可利用信道全部带宽。

      - 缺点：

        - 网络复杂重时产生冲突开销，

      - **ALOHA协议**

        - **纯ALOHA协议**：不监听信道，不按时间槽发送，随机重发。
          - 信道利用率为 1/(2e)。
        - **时隙ALOHA协议**：把时间分成若干个相同的时间片，所有用户在时间片开始时刻同步接入网络信道，若发生冲突，则必须等到下一个时间片开始时刻再发送。
          - 信道利用率为 1/e。

      - **载波监听多路访问（CSMA，Carrier Sense Multiple Access）协议**

        - **1-坚持CSMA**：如果一个主机要发送消息，那么它先监听信道。空闲则直接传输，不必等待。忙则一直监听，直到空闲马上传输。
          - 优点：只要媒体空闲，站点就马上发送，避免了媒体利用率的损失。
          - 缺点：假如有两个或两个以上的站点有数据要发送，冲突就不可避免。
        - **非坚持CSMA**：如果一个主机要发送消息，那么它先监听信道。空闲则直接传输，不必等待。忙则等待一个随机的时间之后再进行监听。
          - 优点：采用随机的重发延退时间可以减少冲突发生的可能性。
          - 缺点：可能存在大家都在延迟等待过程中，使得媒体仍可能处于空闲状态，媒体使用率降低。
        - **p-坚持CSMA**：如果一个主机要发送消息，那么它先监听信道。空闲则以p概率直接传输，不必等待；1-p 概率等待到下一个时间槽再传输。忙则等待一个随机的时间之后再进行监听。
          - 优点：既能像非坚持算法那样减少冲突，又能像1-坚持算法那样减少媒体空闲时间的这种方案。

      - **带碰撞检测的载波监听多路访问（CSMA/CD，carrier sense multiple access with collision detection）协议**：

        - **先听后发，边发边听，冲突停发，随机延迟后重发**。

        - 1、终端设备**不停地检测共享线路的状态**。如果线路空闲，则可以发送数据；如果线路不空闲，则等待一段时间后继续检测（延时时间由退避算法决定）。

          2、如果有另外一个设备同时发送数据，两个设备发送的数据会**产生冲突**。

          3、终端设备**检测到冲突**之后，马上**停止发送自己的数据**，并发送特殊阻塞信息，以强化冲突信号，使线路上其他站点能够尽早检测到冲突。

          4、终端设备检测到冲突后，**等待一段时间之后再进行数据发送**（延时时间由退避算法决定）。

        - 只有当一个站传输了 2τ 之后还没有监听到冲突，才可以确保自己没和其他站点发生碰撞。

        - **截断二进制指数规避算法确定碰撞后的重传时机**

        ![](D:\学习\计算机网络\img\截断二进制指数规避算法确定碰撞后的重传时机.png)

        - 为了确保不会发生这种情况：在检测冲突之前帧就发送完毕，所以要规定帧的**最小帧长** = 总线传播时延 * 数据传输速率 * 2 = 2τ * 数据传输速率。

      - **CSMA/CA协议**

- **传输数据的两种链路**

  - 点对点链路：两个相邻节点通过一个链路相连。
    - 应用：PPP协议，常用语广域网
  - 广播式链路：所以主机共享通信介质。
    - 应用：早期的总线以太网、无线局域网，常用于局域网。
    - 典型拓扑结构：总线型、星型（逻辑总线型）

### 3.3 局域网（以太网与IEEE 802.3、IEEE 802.11）

#### 3.3.1 局域网的基本概念与体系结构

- 局域网（LAN，Local Area Network）：是指在某一区域内由多台计算机互联成的计算机组，使用广播信道。
- 特点：
  - 覆盖的地理范围较小，只在一个相对独立的局部范围内联，如一座或集中的建筑群内。
  - 使用专门铺设的传输介质(双绞线、同轴电缆)进行联网，数据传输速率高(10Mb/s~10Gb/s)。
  - 通信延迟时间短，误码率低，可靠性较高。
  - 各站为平等关系，共享传输信道。
  - 多采用分布式控制和广播式通信，能进行广播和组播。
- 决定局域网的主要要素为：网络拓扑，传输介质与介质访问控制方法。
  - **局域网拓扑结构**
    - **星型拓扑**
      - 优点：
        - 中心节点是控制中心，任意两个节点间的通信最多只需两步，传输速度快。
        - 网络构形简单、建网容易、便于控制和管理。
      - 缺点：
        - 网络可靠性低
        - 网络共享能力差
        - 有单点故障问题
    - **总线型拓扑**
      - 优点：
        - 网络可靠性高
        - 网络节点间响应速度快
        - 共享资源能力强
        - 设备投入量少
        - 成本低、安装使用方便，
        - 当某个工作站节点出现故障时，对整个网络系统影响小。
    - **环型拓扑**
      - 缺点：
        - 存在单点故障问题
        - 不便于扩充
        - 系统响应延时长
        - 信息传输效率较低
    - **树型拓扑**
      - 优点：
        - 易于拓展
        - 易于隔离故障
      - 缺点：
        - 存在单点故障问题
  - **局域网传输介质**
    - 有线局域网常用介质：双绞线、同轴电缆、光纤
    - 无线局域网常用介质：电磁波
  - **局域网介质访问控制方法**
    - **CSMA/CD**：常用于**总线型**局域网，也用于树型网络。
    - 令牌总线：常用于总线型局域网，也用于树型网络。
      - 它是把总线型或树型网络中的各个工作站按一定顺序如按接口地址大小排列形成一个逻辑环。只有令牌持有者才能控制总线，才有发送信息的权力
    - 令牌环：用于逻辑拓扑为环形的局域网，如令牌环网。
- **局域网分类**
  - 以太网：是应用最为广泛的局域网，包括标准以太网(10Mbps)、快速以太网(100Mbps)、千兆以太网(1000Mbps)和10G以太网，它们都符合IE802.3系列标准规范。
    - 逻辑拓扑总线型，物理拓扑是星型或拓展星型。使用 CSMA/CD。
  - 令脚环网物理上采用了星形拓扑结构，逻辑上是环形拓扑结构。已是“明日黄花”。
  - FDDI网（Fiber Distributed Data Interface）物理上采用了双环拓扑结构，逻辑上是环形拓扑结构。
  - ATM网（Asynchronous Transfer Mode）较新型的单元交换技术，使用53字节固定长度的单元进行交换。
  - 无线局域网（WLAN，Wireless Local Area Network）采用IEEE 802.11标准。

#### 3.3.2 以太网与IEEE 802.3

- 以太网两个标准
  - DIX Ethernet V2：第一个局域网产品（以太网）规约。
  - IEEE 802.3：IEEE 802委员会802.3工作组制定的第一个 IEEE 的以太网标准。是一种基带总线型的局域网标准，它描述**物理层**和**数据链路子层MAC子层**的实现方法。
- **以太网提供无连接、不可靠的服务**
  - 无连接：发送方和接收方之间无“握手过程”。
  - 不可靠：不对发送方的数据帧编号，接收方不向发送方进行确认，差错帧直接丢弃，差错纠正由高层负责。

- **传输介质及拓扑结构**

  - 传输介质：粗同轴电缆 --> 细同轴电缆 ---> 双绞线+集线器。
  - 介质访问控制协议：CSMA/CD协议。
  - 经典以太网
    - 拓扑结构：总线型结构
    - 传输介质：粗同轴电缆 --> 细同轴电缆。
  - 交换式以太网：
    - 拓扑结构：逻辑上总线型，物理上星型。
    - 传输介质：双绞线+集线器。

- **适配器和MAC地址**

  - 计算机与外界局域网的连接是通过主机箱内插入的一块网络接口板[又称网络适配器(Adapter)或网络接口卡(Network Interface Card, NIC)]实现的。
  - 网卡上装有处理器和存储器（包括RAM和ROM），是工作在数据链路层的网路组件。
    - ROM上有MAC地址。
  - 网卡是局域网中连接计算机和传输介质的接口，不仅能实现与局域网传输介质之间的物理连接和电信号匹配，还涉及帧的发送与接收、帧的封装与拆封、介质访问控制、数据的编码与解码及数据缓存功能等。
  - MAC地址用于唯一标识一台网络设备。
  - MAC地址长度为48比特，通常用十六进制表示。
    - 前24比特是**组织唯一标识符（OUI，Organizationally Unique Identifier）**，由**IEEE统一分配给设备制造商**。
    - 后24位序列号是**厂商分配给每个产品的唯一数值**，由各个厂商**自行分配**。
  - MAC地址的作用：发送端使用接收端的MAC地址作为目的地址发送数据帧。

- **以太网DIX Ethernet V2标准的MAC帧的格式**

  - 以太网上使用两种标准帧格式，**选择哪种格式由TCP/IP协议簇中的网络层决定**（数据链路层是为上层网络层提供服务的，所以网络层就可以决定封装哪种数据帧格式）。

  ![](D:\学习\计算机网络\img\以太网DIX Ethernet V2标准的MAC帧的格式.png)

  - 前导码（8B）：其功能是使接收器建立比特同步。编码形式为多个“1”或“0”交替构成的二进制序列，最后一比特为“1”。在这种编码形式下，经过曼彻斯特编码后为一周期性方波。
  - 目的地址和源地址：
    - 目的地址字段用来指出帧要发住的工作站。
    - 源地址段指示发送该帧的工作站地址。
  - Ethernet II格式中包含一个Type字段：指定把帧送给哪个进程处理，操作系统需要知道应该调用哪个网络层协议来处理帧携带的数据包。
    - IEEE 802.3格式中，同样的位置是长度字段，定义了Data字段包含的字节数。
  - 数据：
    - MTU：最多可包含1500B。
    - 最少应包含46B，不够则填充。这是为了兼容CSMA/CD协议。
  - 帧检验序列（FCS）：处于帧的最后，是 32 bit 的CRC，用于检验帧在传输过程中有无差错。

- 交换式以太网（10BASE-T以太网）

  - 10BASE-T是传送基带信号的双绞线以太网，T表示采用双绞线，现10BASE-T采用的是无屏蔽双绞线(UTP)，传输速率是10Mb/s。
  - 物理上采用星型拓扑，逻辑上总线型，每段双绞线最长为10m。
    - 每个站使用双绞线连接到集线器。
    - 交换机通过双绞线连接主机或者集线器。
  - 采用曼彻斯特编码。
  - 采用 CSMA/CD介质访问控制。
    - 在集线器中，因为集线器不隔离冲突域，所以必须使用 CSMA/CD 调度各自的传输。
    - 在交换机中，因为交换机隔离冲突域，所以不需要使用 CSMA/CD。

- **高速以太网**：速率大于 100Mb/s 的以太网称为高速以太网
  - 100 BASE-TI以太网
    - 在双绞线上传送100Mb/s基带信号的星型拓扑以太网，仍使用 IEEE 802.3 的 CSMA/CD 协议。
    - 支持全双工和半双工，可在全双工方式下工作而无冲突。
  - 千兆以太网
    - 在光纤或双绞线上传送1Gb/s信号。
    - 支持全双工和半双工，可在全双工方式下工作而无冲突。
  - 万兆以太网
    - 10吉比特以太网在光纤上传送10Gb/s信号。
    - 只支持全双工，无争用问题。

#### 3.3.3 无线局域网IEEE 802.11

- IEEE 802.11是无线局域网的一系列协议标准，它们制定了MAC层协议，运行在多个物理层标准上。
- 802.11的MAC层采用CSMA/CA协议进行介质访问控制。

#### 3.3.4 广域网（ppp协议、HDLC协议）

- 广域网（WAN, Wide Area Network）：通常跨接很大的物理范围，所覆盖的范围从几十公里到几千公里，它能连接多个城市或国家，或横跨几个洲并能提供远距离通信，形成国际性的远程网络。
- 广域网的通信子网主要使用**分组交换技术**。广域网的通信子网可以利用公用分组交换网、卫星通信网和无线分组交换网，它将分布在不同地区的局域网或计算机系统互连起来，达到资源共享的目的。
- **因特网(Internet)是世界范围内最大的广域网**。
- 广域网和局域网的区别和联系

|              | 广域网                                                       | 局域网                                                       |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 覆盖范围     | 很广，通常跨区域                                             | 较小，通常在一个区域内                                       |
| 连接方式     | 点到点连接                                                   | 普遍采用多点接入技术                                         |
| OSI层次      | 三层：物理层，数据链路层，网络层                             | 两层：物理层，数据链路层                                     |
| 联系与相似点 | 1.广域网和局域网都是互联网的重要组成构件，从互联网的角度上看，二者平等（不是包含关系） | 2.连接到一个广域网或一个局域网上的主机在该网内进行通信时，只需要使用其网络的物理地址 |
| 着重点       | 强调资源共享                                                 | 强调数据传输                                                 |

- **广域网**中经常会使用**串行链路**来提供**远距离的数据传输**，有如下两种典型的**串口封装协议**：

  - **高级数据链路控制HDLC（High-Level Data Link Control）**
  - **点对点协议PPP（ Point to Point Protocol）**

- **串口和以太网口的区别**

  - **串口（serial）**：一般用于**广域网**，它可以用作PPP、帧中继等网络类型的连接端口，用于远距离数据传输。
  - **以太网口（Ethernet）**：一般用于**局域网**，它可以作为以太网的连接端口，用于短距离数据传输。

- 串行链路中定义了两种数据传输方式：异步和同步。

  - **异步传输：**是以**字节**为单位来传输数据，并且需要采用额外的起始位和停止位来标记每个字节的开始和结束。起始位为二进制值0，停止位为二进制值1。在这种传输方式下，开始和停止位占据发送数据的相当大的比例，每个字节的发送都需要额外的开销。
  - **同步传输：**是以**帧**为单位来传输数据，在通信时需要使用**时钟**来同步本端和对端的设备通信。DCE即数据通信设备，它提供了一个用于同步DCE设备和DTE设备之间数据传输的时钟信号。DTE即数据终端设备，它通常使用DCE产生的时钟信号。

- **点到点协议（Point to Point Protocol，PPP）**

  - [10张图带你搞懂数据链路层PPP点到点协议](https://zhuanlan.zhihu.com/p/153515394)

  - 一种点到点(一根链路两端只有两个接口)的**链路层协议**，主要用于在**全双工**的同异步链路上进行点到点的数据传输。

  - 设计目的主要是用来通过拨号或专线方式建立点对点连接发送数据，使其成为各种主机、网桥和路由器之间简单连接的一种共通的解决方案。

  - 特点：

    - 对于链路层的帧，无需纠错，无需序号，无需流量控制。
    - 透明传输：异步线路用字节填充，同步线路用比特填充。
    - 多种网络层协议：封装的P数据报可以采用多种协议。
    - 多种类型链路：串行/并行，同步/异步，电/光。
    - 差错检测：错就丢弃。
    - 检测连接状态：链路是否正常工作。
    - 最大传送单元：数据部分最大长度MTU.
    - 网络层地址协商：知道通信双方的网络层地址。
    - **PPP提供了LCP（Link Control Protocol）协议**，用于建立并维护数据链路连接。
    - **PPP提供了各种NCP（Network Control Protocol）协议（如IPCP、IPXCP）**，PPP可支持多种网络层协议，每个不同的网络层协议都要一个相应的NCP来配置，为网络层协议建立和配置逻辑连接。。
    - **PPP提供了认证协议：**CHAP（Challenge-Handshake Authentication Protocol）、PAP（Password Authentication Protocol），更好的保证了网络的安全性。

  - **PPP帧协议的帧格式**

    ![](D:\学习\计算机网络\img\PPP帧协议的帧格式.png)

    - **Flag域**：标识一个物理帧的起始和结束，该字节为二进制序列01111110（0X7E）；
    - **Address 域**：字节固定为 11111111（0XFF），是一个广播地址；
    - **Control 域：**默认为00000011(0X03)，表明为无序号帧；
    - **Protocol字段**：用来说明PPP所封装的协议报文类型。典型的字段值有：
      - **0XC021**代表LCP报文
      - **0XC023**代表PAP报文
      - **0XC223**代表CHAP报文。
    - **information字段**：包含协议字段中指定协议的数据包。
    - **帧校验序列（FCS）**：是个16位的校验和，用于检查PPP帧的完整性。

### 3.4 数据链路层设备（网桥、交换机）

- **网桥**：
  - 数据链路层设备，处理对象是帧。
  - 能够隔离冲突域。
  - 两个或多个以太网通过网桥连接后，就成为一个覆盖范围更大的以太网，而原来的每个以太网就称为一个**网段**。
  - 网段：一般指一个计算机网络中使用同一物理层设备（传输介质，中继器，集线器等）能够直接通讯的那部分。
  - **网桥信息处理方式**
    - 网桥接收到接口 A 发送来的数据帧后，检查帧中的地址：
      - 如果输出端口和输入端口相同，则将帧丢弃。
      - 如果输出端口和输入端口不同，则通过对应接口转发给该网络。
      - 如果输出端口未知，则使用泛洪法，将帧转发到除输入端口以外的所有端口。
  - **网桥的吞吐量**
    - 因为网桥可以隔离冲突域，所以多个网段的最大吞吐量是所有网段吞吐率的叠加。
  - **网桥的基本特点**
    - 网桥必须具备寻址和路径选择能力，以确定帧的传输方向;
    - 从源网络接收帧，以目的网络的介质访问控制协议向目的网络转发该帧;
    - 网桥在不同或相同类型的LAN之间存储并转发帧，必要时还进行链路层上的**协议转换**。注意，一般情况下，存储转发类设备都能进行协议转换，即连接的两个网段可以使用不同的协议;
    - 网桥对接收到的帧不做任何修改，或只对帧的封装格式做很少的修改;
    - 网桥可以通过执行帧翻译互联不同类型的局域网，即把原协议的信息段的内容作为另-种协议的信息部分封装在帧中;
    - 网桥应有足够大的**缓冲空间**，因为在短时间内帧的到达速率可能高于转发速率。
  - 优点
    - 能过滤通信量;
    - 扩大了物理范围;
    - 可使用不同的物理层;
    - 可互联不同类型的局域网;
    - 提高了可靠性;
    - 性能得到改善。
  - 缺点:
    - 增大了时延;
    - MAC子层没有流量控制功能（流量控制需要用到编号机制，编号机制的实现在LLC子层）;
    - 不同MAC子层的网段桥接在一起时，需要进行帧格式的转换;
    - 网桥只适合于用户数不多和通信量不大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞，这就是所谓的广播风暴。

- **局域网交换机**
  - 动机：网桥的主要限制是在任一时刻通常只能执行一个帧的转发操作，于是出现了局域网交换机，又称以太网交换机。
  - 以太网交换机是一个多端口的网桥，属于数据链路层设备，能隔离冲突域。
  - 转发表的构建（自学习算法）：
    - 每接收到一个帧，将｛源MAC地址，接收端口，时间｝记录为转发表的一项。
    - 在转发帧时，则根据收到的帧首部中的目的地址来转发。
    - 如果转发表中没有对应目的地址的表项， 则使用泛洪算法，将帧输出到除输入端口以外的所有端口。
    - 定期会扫描转发表，清除几分钟内都没更新的表项。



## 第 4 章 网络层

- [我画了 40 张图就是为了让你搞懂计算机网络层](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247487683&idx=1&sn=e0949e72e039759545450852d8bc0ada&chksm=e999e5d1deee6cc7ab9e42b50329924fee39c45955516b406046605d27928825a0f628d13e7c&scene=21#wechat_redirect)

- **数据交换方式**：
  - **电路交换**：双方在通信前先建立**独占的物理通信路径**，数据通过该路径进行传输，通信结束后才释放路径。
    - 三个阶段：
      - 连接建立
      - 数据传输
      - 连接释放
    - 在数据传输的过程中，**用户始终占用端到端的固定传输带宽**。
    - 优点：
      1. **通信时延小**。由于通信线路为通信双方用户专用，数据直达，因此传输数据的时延非常小。当传输的数据量较大时，这个优点非常明显。
      2. **有序传输**。双方通信时按发送顺序传送数据，不存在失序问题。
      3. 没有冲突。不同的通信双方拥有不同的信道，不会出现争用物理信道的问题。
      4. 适用范围广。电路交换既适用于传输模拟信号，又适用于传输数字信号。
      5. **实时性强**。通信双方之间的物理通路一旦建立， 双方就可以随时通信。
      6. 控制简单。电路交换的交换设备(交换机等)及控制均较简单。
    - 缺点：
      1. **建立连接时间长**。电路交换的平均连接建立时间对计算机通信来说太长。
      2. **线路独占，利用率低**。电路交换连接建立后，物理通路被通信双方独占，即使通信线路空闲，也不能供其他用户使用，因而信道利用率低。
      3. **灵活性差**。只要在通信双方建立的通路中的任何一点出了故障，就必须重新拨号建立新的连接，这对十分紧急和重要的通信是很不利的。
      4. 难以规格化。电路交换时，数据直达，不同类型、不同规格、不同速率的终端很难相互进行通信，也难以在通信过程中进行差错控制。
  - **报文交换**：双方通信前不建立连接，将报文由交换设备进行**存储-转发方式**传输。
    - 数据交换的单位是报文，报文携带有源地址，目标地址，数据等信息。
    - **工作方式：存储-转发方式**。
      - 网络节点存储接受到的报文，判断其目标地址以选择路由，并将报文转发给下一跳路由。
    - 优点：
      1. **无须建立连接**。报文交换不需要为通信双方预先建立一条专用的通信线路，不存在建立连接时延，用户可以随时发送报文。
      2. **动态分配线路**。当发送方把报文交给交换设备时，交换设备先存储整个报文，然后选择一条合适的空闲线路，将报文发送出去。
      3. **线路可靠性高**。如果某条传输路径发生故障，那么可重新选择另一条路径传输数据，因此提高了传输的可靠性。
      4. **线路利用率高**。通信双方不是固定占有一条通信线路，而是在不同的时间一段一段地部分占有这条物理通道，因而大大提高了通信线路的利用率。
      5. 提供多目标服务。一个报文可以同时发送给多个目的地址，这在电路交换中是很难实现的。
    - 缺点：
      1. **存在存储转发时延**。因为路由器需要存储、转发报文。
      2. **要求网络节点有较大的缓存**。因为报文交换对报文的大小没有限制。
  - **分组交换（存储-转发数据包交换）**：将大的报文段划分为小的数据包，由交换设备进行存储-转发方式传输。
    - 工作方式：存储-转发方式
      - 将报文划分为多个小数据块，再加上一些必要的控制信息(如源地址、目的地址和编号信息等)，构成数据包。
      - 网络节点存储接受到的数据包，判断其目标地址以选择路由，并将报文转发给下一跳路由。
      - 到达目的地的数据包再重新组合起来，形成一条完整的数据。
    - 优点：
      1. **无建立时延**。不需要为通信双方预先建立一条专用的通信线路，不存在连接建立时延，用户可随时发送分组。
      2. **动态分配线路**。当发送方把报文交给交换设备时，交换设备先存储整个报文，然后选择一条合适的空闲线路，将报文发送出去。
      3. **线路可靠性高**。如果某条传输路径发生故障，那么可重新选择另一条路径传输数据，因此提高了传输的可靠性。
      4. **线路利用率高**。通信双方不是固定占有- -条通信线路，而是在不同的时间一-段一段地部分占有这条物理通路，因而大大提高了通信线路的利用率。
      5. 简化了存储管理(相对于报文交换)。因为分组的长度固定，相应的缓冲区的大小也固定，在交换结点中存储器的管理通常被简化为对缓冲区的管理，相对比较容易。
      6. **加速传输**。**数据包以流水线方式进行传输**，大大减少了报文的传输时间。
      7. 降低了对网络节点的缓存空间的要求。传输一个数据包所需的缓冲区比传输一次报文所需的缓冲区小得多，这样因缓冲区不足而等待发送的概率及时间也必然少得多。
      8. 减少了出错概率和重发数据量。因为分组较短，其出错概率必然减小，所以每次重发的数据量也就大大减少，这样不仅提高了可靠性，也减少了传输时延。
    - 缺点：
      1. **存在存储转发时延**。不过分组交换的存储转发时延小于报文交换。
      2. **需要传输额外的信息量**。每个小数据块都要加上源地址、目的地址和分组编号等信息，从而构成分组，因此使得传送的信息量增大了5%~10%，一定程度上降低了通信效率，增加了处理的时间，使控制复杂，时延增加。
    - 根据网络层提供给传输层的服务划分：
      - 无连接的**数据报**方式
        - 对应的网络称为**数据报网络**。
        - 所有的**数据报**被独立注入到网络中，并且**每个数据包（数据报）独立路由**。
        - 可能会出现失序、丢失或重复分组，分组到达目的结点时，要对分组按编号进行排序等工作。
      - 面向连接的**虚电路**方式
        - 在发送数据报之前，必须先建立连接原路由器和目标路由器的**虚电路**，数据包沿该路径传输。
        - 无失序问题，但有虚电路建立、数据传输和虚电路释放三个过程。

![](D:\学习\计算机网络\img\电路交换、报文交换、分组交换的交换方式比较.png)

### 4.1 网络层的功能

- **主要功能**：**将数据包（数据报）从源端路由到接收方。**
  
  - **路由选择**：指按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由。
  - **分组转发**：指路由器根据**转发表**将用户的 IP 数据报从合适的端口转发出去。
  - **拥塞控制**：网络中存在太多的数据包导致数据包被延迟和丢失，从而降低了传输性能的情况。
  - 服务质量
  - 网络互联
  - 流量控制
  - 差错控制
  
- 网络层提供给传输层的服务：
  - **无连接**服务（提供给 UDP）

    - 所有的**数据报**被独立注入到网络中，并且**每个数据包（数据报）独立路由**。

      - 路由器基于路由算法构建**转发表**。
    - 路由器根据数据报的目的地址进行路由选择。
      
    - 对应的网络称为**数据报网络**。
      
      - 注：**如果传输层协议使用的是 UDP 协议，则网络层采用无连接服务，只有在这种情况，数据包也可称为数据报。**
      
        - 因为 **UDP 直接面向报文**，发送方 UDP 对应用层交下来的报文，在添加首部后就向下交付给 IP 层，**既不合并，也不拆分**，而是保留这些报文的边界。
      - **数据包（Packet）：**一种协议数据单元（PDU），它的起始和目的地是**网络层**。
        - **数据报（Datagram）：**通常是指起始点和目的地都使用**无连接**网络服务的的**网络层**的信息单元。
      - 出于以上原因，以后**将数据报网络中传输的数据包都称为数据报**。
      
    - **数据报网络中网络层的分片**：
      - 因为 UDP 直接面向报文，**当报文过长时，网络层必须对其进行分片**。
        - 假设要传输一个 UDP 数据报，以太网的 MTU 为1500字节，一般 IP 首部为20字节，UDP 首部为8字节，数据的净荷（payload）部分预留是 1500-20-8=1472 字节。如果数据部分大于1472字节，就会出现分片现象。
        - 不仅源端主机会进行分片，**中间的路由器也有可能分片**，因为不同的网络的 MTU 是不一样的，如果传输路径上的某个网络的 MTU 比源端网络的 MTU 要小，路由器就可能对 IP 数据报再次进行分片。而**分片数据的重组只会发生在目的端的 IP 层**。
      - **网络层分片应尽量避免**。
        - 每个片在到达目的地后会进行重组，准确的来说是在传输层之前会进行重组，TCP 和 UDP 都会希望发送完整的、未分片的报文，出于性能的原因，分片重组不会在路由器中进行，而是会在目标主机中进行重组。
        - **IP 层是没有超时重传机制**的，如果 IP 层对一个数据包进行了分片，只要有一个分片丢失了，只能依赖于传输层进行重传，结果是所有的分片都要重传一遍，这个代价有点大。
        - 所以对于 UDP 包，我们需要在应用层去限制每个包的大小，一般不要超过1472字节，即以太网 MTU（1500）- UDP 首部（8）- IP 首部（20）。
      - **如何实现分片？**详情见 IPv4 中协议格式·。
        - 同一个数据报的所有片都具有相同的源地址、目的地址、**标识号**。
          - 标志字段的最低位为MF，MF= 1 表示后面还有分片，MF= 0 表示最后一个分片。
          - 标志字段中间的一位是DF，只有当 DF =0 时才允许分片。
          - 使用**片偏移**指定分片应该在数据报的哪个位置。
    
  - **面向连接**的服务（提供给 TCP）

    - 在发送数据报之前，必须先建立连接原路由器和目标路由器的**虚电路**，数据包沿该路径传输。

      - 路由器维持一张**虚电路表**，格式如下：

      ![](D:\学习\计算机网络\img\虚电路网络的路由过程.png)

      | 入境线路 | 虚电路号 | 出境线路 | 虚电路号 |
      | -------- | -------- | -------- | -------- |
      | H1       | 1        | C        | 1        |
      | H3       | 1        | C        | 2        |

    - 对应的网络称为**虚电路网络**。

    - **虚电路网络中的网络层不需要分片，因为传输层会预先对报文进行分片。**

      - 在建立连接的三次握手的过程中，连接双方会相互通告 MSS（Maximum Segment Size，最大报文段长度），MSS 一般是 `MTU - IP 首部 - TCP首部 = 1500B - 20B - 20B = 1460B`，每次发送的TCP数据都不会超过双方MSS 的最小值，所以就保证了 IP 数据包不会超过 MTU，避免了 IP 分片。

|                    | 数据报网络                                   | 虚电路网络                                                   |
| ------------------ | -------------------------------------------- | ------------------------------------------------------------ |
| 电路建立           | 无连接                                       | 面向连接                                                     |
| 寻址               | 每个数据报包含全部的源和目标地址             | 数据包包含简短的虚电路（VC）号                               |
| 状态信息           | 路由器不保存连接状态                         | 每条虚电路都需要路由器保存其状态                             |
| 路由方式           | 路由器维护转发表，每个数据报被独立路由       | 路由器维护虚电路表，建立虚电路时选择路由路径，所有数据报都遵循此路径 |
| 数据包到达顺序     | 不保证有序到达                               | 保证有序到达                                                 |
| 路由器失效的影响   | 没影响，除了路由器崩溃期间丢失的包           | 经过故障路由器的所有虚电路都将被中断                         |
| 服务质量           | 困难                                         | 容易，如果在预先建立虚电路时有足够的资源可分配               |
| 拥塞控制           | 困难                                         | 容易，如果在预先建立虚电路时有足够的资源可分配               |
| 差错控制和流量控制 | 由用户主机进行流量控制，不保证数据报的可靠性 | 可由分组交换网负责，也可由用户主机负责                       |

### 4.2 交换机、路由器与路由算法

- 参考资料：

  - [【科普】路由基础（一）-超有趣学网络](https://zhuanlan.zhihu.com/p/26222004)
  - [路由器你竟然是这样的...](https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzI0ODk2NDIyMQ%3D%3D%26mid%3D2247487351%26idx%3D1%26sn%3D9aa613589f85ce4c0c4142274e2a287d%26chksm%3De999fa65deee73732f97267db0e58d28925f4c57f7850d1e3b4633275385ac844e204fd03f03%26scene%3D21%23wechat_redirect)
  - [交换机系列（四）丨浅谈三层交换技术](https://www.toutiao.com/a6373513512204026114/?wid=1622193222721)
- [三层交换机与路由器傻傻分不清楚，今天学习一下](https://zhuanlan.zhihu.com/p/64455461)

|                                | 能否隔离冲突域 | 能否隔离广播域 |
| ------------------------------ | -------------- | -------------- |
| 物理层设备（中继器、集线器）   | 不能           | 不能           |
| 链路层设备（网桥、二层交换机） | 能             | 不能           |
| 网络层设备（路由器）           | 能             | 能             |

#### 4.2.1 **交换机**

- **MAC地址映射表**：记录MAC地址和端口的映射。

| MAC地址           | 端口 |
| ----------------- | ---- |
| 00-10-B5-4B-30-85 | E0/1 |
| 00-10-B5-4B-30-90 | E0/2 |

- **三个基本功能**：
  - **学习**：以太网交换机了解每一端口相连设备的MAC地址，并将地址同相应的端口映射起来存放在交换机缓存中的**MAC地址表**中。
  - **转发/过滤**：当一个数据帧的目的地址在MAC地址表中有映射时，它被转发到连接目的节点的端口而不是所有端口（如该数据帧为广播/组播帧则转发至所有端口)。
  - **消除回路**：当交换机包括一个冗余回路时，以太网交换机通过生成树协议避免回路的产生，同时允许存在后备路径。

- **二层交换机**
  - **数据链路层**设备。
  - 适用环境：小型的局域网络。
  - 功能：
    - 数据交换
  - **工作过程**：
    1. 交换机根据收到数据帧中的源MAC地址建立该地址同交换机端口的映射（学习功能），并将其写入**MAC地址表**中。
    2. 交换机将数据帧中的目的MAC地址同已建立的MAC地址表进行比较，以决定由哪个端口进行转发。
    3. 如果数据帧中的目的MAC地址不在MAC地址表中，则向所有端口转发。这一过程称为**泛洪（flood）**。
    4. 广播帧和组播帧向所有的端口转发。
  - 优点：
    - 数据交换由硬件实现，速度快。
    - 只需要知道数据包的 MAC 地址。
- 缺点：
    - 无法处理不同 IP 子网之间的数据交换。
  
- **三层交换机**
  - **三层交换技术**的动机：
    - 二层交换机无法处理不同 IP 子网之间的数据交换。
    - 传统的路由器可以处理大量的跨越 IP 子网的数据包，但是转发效率远比二层低。
  - **数据链路层**和**网络层**设备。因此三层交换机由以下模块组成：
    - 二层交换模块
    - 三层路由模块
  - 适用环境：大型的局域网络。
  - 功能：
    - 数据交换
    - 基本的路由转发，但远没有路由器那么完备。
  - 工作过程：假设设备 A 要给 设备 B 发送数据，途经三层交换机。
    - 如果 A 和 B 在同一网段
      - 如果 A 不知道 B 的 MAC 地址，A就发送一个 ARP 请求，B 返回其 MAC 地址，A 用此 MAC 地址封装数据包形成**帧**并发送给交换机。
      - 交换机起用二层交换模块，查找 MAC 地址表，将数据包转发到相应的端口。
    - 如果 A 和 B 不在同一网段
      - A 需要向缺省网关发出 ARP（地址解析）封包。值得注意的是，不同于二层交换机的缺省网关是路由器，**这里的缺省网关的 IP 地址其实是三层交换机的三层交换模块**。
      - 如果三层交换模块在以前的通信过程中已经知道 B 的 MAC 地址，则向发送站 A 回复 B 的 MAC 地址。
      - 将第一个数据包发至默认网关（路由器，一般具有该网络的最低地址）。
      - 如果三层交换模块未和 B 站点通信过，不知 B 的 MAC 地址，则会根据路由信息向 B 广播一个 ARP 请求，B 得到此 ARP 请求后向三层交换模块回复其 MAC 地址，三层交换模块保存此地址并回复给 A，同时将 B 的 MAC 地址发送到二层交换引擎的 MAC 地址表中。
      - 此后，A 向 B 发送的全部数据包通通交给二层交换来处理，无需再通过三层进行路由，从而实现高速数据交换。
      - 这就通常所说的**一次路由，多次转发**。
  - 优点：
    - 数据包转发效率高。数据通信仅仅在路由过程中才需要三层处理，绝大部分数据都通过二层交换转发，因此三层交换机的速度很快，基本接近二层交换机的转发速度。

#### 4.2.2 **路由器**

- 参考资料：
  - [网络工程师（10）：让路由告诉你该去哪](https://zhuanlan.zhihu.com/p/133094539)
  - [路由表和路由转发表（fib表）的区别 ](https://www.sohu.com/a/342616410_99906077)

- **转发**：**指将分组从一个输入链路转移到适当输出链路接口的路由器本地动作**。

- **路由选择**：**指确定分组从源到目的地所定位的路径的选择**。

- **一跳是指从源 MAC 地址到目标 MAC 地址之间传输帧的区间**。

  - 路由器的每一跳都需要询问当前中转的路由器，下一跳应该跳到哪里，从而跳转到目标地址。

- **路由表与转发表**：

  - 路由表是根据路由选择算法得出的，而转发表是从路由表得出的。
  - 路由表则需要对网络拓扑变化的计算最优化，转发表的结构应当使查找过程最优化。

  ![](D:\学习\计算机网络\img\路由示例1.jpg)

  - R1 的路由表

  | 目标地址/掩码 | 路由来源                       | 度量值 | 下一跳   | 出接口 |
  | ------------- | ------------------------------ | ------ | -------- | ------ |
  | 0.0.0.0/0     | static（静态路由中的默认路由） | 0      | 10.1.2.2 | E1/1   |
  | 10.1.1.0/24   | direct（直连路由）             | 0      | 10.1.1.1 | E0/1   |
  | 10.1.2.0/24   | direct                         | 0      | 10.1.2.1 | E1/1   |
  - R2 的路由表

  | 目标地址/掩码 | 路由来源 | 度量值 | 下一跳   | 出接口 |
  | ------------- | -------- | ------ | -------- | ------ |
  | 10.1.1.0/24   | static   | 0      | 10.1.2.1 | E0/1   |
  | 10.1.2.0/24   | direct   | 0      | 10.1.2.2 | E0/1   |
  | 10.1.3.0/24   | direct   | 0      | 10.1.3.1 | E1/1   |
  | 10.1.4.0/24   | static   | 0      | 10.1.3.2 | E1/1   |

  - 静态路由和直连路由的出接口相同时，为啥下一跳不同？
    - 直连路由就是目标网络与路由器接口的映射。
    - 静态路由的目标地址不是直连网络，下一跳是下一个路由器的地址。

- **路由器的组成**

  ![](D:\学习\计算机网络\img\路由器1.png)

  - **输入端口(input port)**：
    - 功能：
      - **线路终端功能**和**数据链路处理**功能，这两个功能实现了路由器的单个输入链路相关联的物理层和数据链路层。
      - **输入端口查找/转发功能**对路由器的交换功能来说至关重要，由路由器的交换结构来决定输出端口，具体来讲应该是查询转发表来确定的。
    - 每个输入端口中都有一个路由选择处理器维护的**路由表的副本**，根据路由选择处理器进行更新。这个路由表的副本能够使每个输入端口独立处理转发，而无需经过路由选择处理器统一处理，**避免了路由选择处理器统一处理造成转发瓶颈**。
    - **输入端口会根据转发表定位输出端口**，然后再进行**分组转发**。输出端口的定位遵循**最长前缀原则**。
    - 一旦通过查找功能确定了分组的输出端口后，那么该分组就会进入交换结构。在进入交换结构时，如果交换结构正在被使用，就会阻塞新到的分组，等到交换结构调度新的分组。

  ![](D:\学习\计算机网络\img\路由器2.png)

  - **交换结构(Switching fabric)**：就是将路由器的输入端口连接到它的输出端口。这种交换结构相当于是路由器内部的网络。
    - 交换结构有多种形式，主要分为 **通过内存交换、通过总线交换、通过互联网络进行交换**。
  - **路由选择处理器(Routing processor)**： 在路由器内执行路由协议，维护路由表并执行网络管理功能。
  - **输出端口(Output ports)**：输出端口取出已经存放在输出端口内存中的分组并将其发送到输出链路上。包括选择和去除排队的分组进行传输，执行所需的链路层和物理层的功能。

  ![](D:\学习\计算机网络\img\路由器3.png)

- **功能：根据路由选择算法，为经过的每个数据包传送到下一跳节点**。

  - **转发分组**

    - **流程步骤**：
      1. 经过物理层、数据链路层处理后，从数据包的首部提取目的主机的IP地址D，得出目的网络地址N。
      2. 查询**转发表**，根据数据包的目的地址选择最佳路由，将数据包转发到下一跳设备。
         - 先处理直连路由，在处理静态路由，最后处理动态路由。
         - 对路由表的每个表项中的子网掩码和 D 进行**位与**运算，其结果为 N，如果 N 与该行的目的地址匹配，则将数据包转发给该表项的下一跳路由器。
      3. 若转发表中没有匹配的目标地址，则把数据包传送给路由表中所指明的**默认路由**。

  - **选择最佳路由**

    - **最长掩码匹配原则**：有多条路由都能匹配目的地址的时候，选择其中掩码最长的路由。
    - **管理性距离（AD）选路原则**：同一台路由器，在运行两种（或以上）动态路由协议（同时运行RIP、OSPF等）的前提下，有多条路由都能匹配目的地址的时候，且这时候掩码一样（跳过最长掩码匹配原则），这时候使用管理距离进行选路，管理性距离越小越优。

    ![](D:\学习\计算机网络\img\管理性距离(AD)选路原则.png)

    - **相同协议 metric 匹配原则**：有多条路由都能匹配目的地址的时候，且这时候掩码一样(跳过最长掩码匹配原则)，且这时候管理性距离一样(相同协议,这时候跳过管理性距离(AD)选路原则)。在同一个协议内判度量值。
      - RIP: HOP 值（最大值15）越小越优。
      - OSPF: COST 值越小越优。
      - EIGRP:  FD 值。

  - **验证和维护路由信息**

    - 查看路由表的命令：`show ip route`
    - **直连路由**：目标网络与路由器接口的映射。
    - **静态路由**：手动配置的路由。
      - 适用环境：
        - 网络简单的环境。
        - 内外网对接设备。
      - 配置：`ip route 192.168.1.0 255.255.255.0 F0/0`
      - 分类：
        - **默认路由**：0.0.0.0/0
          - 作用：没有匹配的路由时，匹配默认路由。
          - 在现实的网络中，对于一个网络的出口(连接到运营商网设备)大多数使用默认路由的方式，把所有内网未知的流量全部丢给运营商。
        - **静态路由 null0**
          - null0 其实是一个空接口，只要数据丢给这个接口就是把数据给丢弃掉。
          - 作用：防止环路
    - **动态路由**：通过动态路由协议学习的路由。
      - 距离矢量路由协议（RIP）
        - 所有路由器掌握完整的路由拓扑和链路费用信息。
      - 链路状态路由协议（OSPF）
        - 路由器值掌握物理相连的邻居及链路费用。

#### 4.2.3 动态路由算法

- [网络知识复习—动态路由协议-RIP（距离矢量路由协议）](https://zhuanlan.zhihu.com/p/110599663)
- [OSPF路由协议](https://zhuanlan.zhihu.com/p/63621910)

- **AS（Autonomous system，自治系统）**：，指在一个（有时是多个）组织管辖下的所有 IP 网络和路由器的全体，它们对互联网执行共同的路由策略。
- 路由算法的分类：
  - 静态路由（非自适应算法）
  - 动态路由（自适应算法）
    - 内部网关路由协议：一个AS内部所使用的一种路由协议。
      - 距离矢量协议（RIP）
      - 链路状态协议（OSPF）
    - 外部网关路由协议：在多个AS之间使用的一种路由协议。
      - BGP
- AS（自治域系统）内部使用内部网关协议； AS与AS之间使用外部网关协议。

##### 4.2.3.1 距离矢量路由协议（Routing Information Protocol ，路由信息协议）

- **基于 UDP 的应用层协议**。
- 适用范围：小型自治系统。
- 管理性距离（AD）：120。
- 配置命令：

```bash
# Router(config)#router rip //启动RIP路由选择进程
# Router(config-router)#network network-number //宣告指定的直连网络(接口)
# 例如：Router(config-router)#network 1.1.1.0
```

- 特点：
  - **度量值**表示距离、延迟，度量值越小越优。
  - **只与相邻路由器交换度量值**。
- 工作过程：
  - 每隔一段周期时间收到相邻路由器发来的 RIP 报文，并将每个表项的度量值增加当前路由器到相邻路由器的度量值。
  - 比较收到的 RIP 报文与路由表中的度量值（表示距离），对于每一个目标地址，如果 RIP 报文表项中地址的距离度量值，则更新路由表。
  - 如果长时间没有收到相邻路由器的 RIP 报文，则把到该路由器的距离设置为16。
- 缺陷：
  - **收敛速度慢**：根据广播更新整张路由表，并且是逐跳的更新。
  - **环路问题（无穷计算问题）**
    - **RIP防环机制**
      - **定义最大度量值以防止计数至无穷大**：规定最大跳数为16，凡是达到16跳为不可达路由。
      - **水平分割**：路由器从一个端口收到路由更新消息，那么在广播自己的路由表时就不会发送至该接口。

##### 4.2.3.2 链路状态路由协议（Open Shortest Path First，开放最短路径优先）

- 动机：RIP 协议不适用于较大型的自治系统，因此在较大型的自治系统中常使用 OSPF。

- **基于 IP 的网络层协议**。直接用 IP 数据报传送。

- 适用范围：大型自治系统。

- 管理性距离（AD）：110。

- 特点：

  - **度量值**表示到达目的地的开销 Cost = 参考宽带（10^8）/ 接口带宽（b/s）。
  - 使用洪泛法向自治系统内所有路由器发送信息，最终整个区域内所有路由器都得到了这个信息的一个副本。
  - 发送的信息就是与本路由器相邻的所有路由器的链路状态（本路由器和哪些路由器相邻，以及该链路的度量/代价ー一费用、距离、时延、带宽等）。
  - 只有当链路状态发生变化时，路由器才向所有路由器洪泛发送此信息。
  - 最终所有路由器都能建立一个链路状态数据库，即全网拓扑图。
  - **OSPF 区域**：
    - 为使OSPF能够用于规模很大的网络，OSPF将一个自治系统再划分为若干更小的范围，称为区域。
    - 在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑情况。
    - 不同区域之间的交流需通过区域边界路由器和主干路由器。
    - 不同自治系统之间的交流通过自治系统边界路由器。
    - 优点：
      - 将利用洪泛法交换链路状态信息的范围局限于每个区域而非整个自治系统，减少了整个网络上的通信量。
      - 减小路由表大小。
      - 多区域提高了网路的拓展性，有利于组建大规模网络。

  ![](D:\学习\计算机网络\img\OSPF的区域.png)

- 工作过程：

  1. 每个路由器发现它的邻居结点[HELO问候分组]，并了解邻居节点的网络地址。
  2. 设置到它的每个邻居的成本度量 metric
  3. 构造[DD数据库描述分组]，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
  4. 如果DD分组中的摘要自己都有，则邻站不做处理：如果有没有的或者是更新的，则发送[LSR链路状态请求分组]请求自己没有的和比自己更新的信息。
  5. 收到邻站的LSR分组后，发送[LSU链路状态更新分组]进行更新。
  6. 更新完毕后，邻站返回一个[ LSACKI链路状态确认分组]进行确认。
  7. 只要一个路由器的链路状态发生变化：
     1. 泛洪发送[LSU链路状态更新分组]进行更新
     2. 更新完毕后，其他站返回一个[ LSACK链路状态确认分组]进行确认。
     3. 使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径。

- 优点：

  - 收敛速度快。

##### 4.2.3.3 外部网关路由协议（Border Gateway Protocol ，边界网关协议）

- 动机：替代传统的 EGP（Exterior Gateway Protocol）。

- **基于 TCP 的应用层协议**。
- 适用范围：互联网。
- 管理性距离（AD）：EBGP 为 20，IBGP 为 200。
- **BGP 也可以应用在一个 AS 内部**，根据是否应用在同一个 AS 可以划分为：
  - IBGP（Interior BGP ：同一个AS之间的连接）用于大规模自治系统。
    - OSPF 在大规模 AS 中存在性能瓶颈，此时需要使用 IBGP。
  - EBGP（Exterior BGP：不同AS之间的BGP连接）用于互联网。

- 特点：
  - 与其他 AS 的邻站 BGP 发言人交换网络可达性的信息。
- 工作过程：

### 4.3 IPv4

#### 4.3.1 **IP 数据包格式**：

![](D:\学习\计算机网络\img\ipv4格式.png)

- IP首部的部分重要字段含义如下（牢记长度单位，**一总八片首四**）:
  1. **版本**。占4位。指IP的版本，目前广泛使用的版本号为4。
  2. **首部长度**。占4位。**以4B为单位**，**最大值为60B (15*4B)**。最常用的首部长度是20B,此时不使用任何选项(即可选字段)。
  3. **总长度**。占16位。指首部和数据之和的长度，**单位为B**，因此数据报的最大长度为216-1= 65535B。
     - **以太网帧的最大传输单元（MTU）为1500B**，当报文段的长度过大时，IP 层就会进行**分片**。
  4. **标识**。占16位。它是一个计数器，每产生一个数据报就加1,并赋值给标识字段。但它并不是“序号”(因为IP是无连接服务)。当一个数据报的长度超过网络的MTU时，必须分片，此时**每个数据报片都复制一次标识号**， 以便能正确重装成原来的数据报。
  5. **标志**。占3位。
     - 标志字段的最低位为MF，MF= 1 表示后面还有分片，MF= 0 表示最后一个分片。
     - 标志字段中间的一位是DF，只有当 DF =0 时才允许分片。
  6. **片偏移**。占13位。它指出较长的分组在分片后，某片在原分组中的相对位置。**片偏移以 8B 为偏移单位，即每个分片的长度一定是 8B (64 位)的整数倍。**
  7. **生存时间(TTL)**。占8位。数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。**路由器在转发分组前，先把TTL减1。若TTL被减为0，则该分组必须丢弃。**
  8. **协议**。占8位。指出此分组携带的数据使用何种协议，即分组的数据部分应交给哪个传输层协议，如TCP、UDP等。
     - TCP：6
     - UDP：17
  9. **首部校验和**。占16位。IP 数据报的首部校验和**只校验分组的首部，而不校验数据部分**。
  10. **源地址字段**。占4B，标识发送方的IP地址。
  11. **目的地址字段**。占4B，标识接收方的IP地址。

#### 4.3.2 **IPv4 地址**

- 传统的IP地址是分类的地址，分为`A、B、C、D、E`五类。
- IP 地址由**网络号**和**主机号**组成。

![](D:\学习\计算机网络\img\IPv4地址.png)
- **常用IP地址ABC使用范围**

  | 网络类别 | 最大可用网络数 | 第一个可用的网络号 | 最后一个可用的网络号 | 每个网络中的最大主机数 |
  | -------- | -------------- | ------------------ | -------------------- | ---------------------- |
  | A        | 2^7 - 2        | 1                  | 126                  | 2^24 - 2               |
  | B        | 2^14 - 1       | 128.1              | 161.255              | 2^16 - 2               |
  | C        | 2^21 - 1       | 192.0.1            | 223.255.255          | 2^8 - 2                |

  - 可用网络号不能为全0，也不能为127（表示环回地址）。
  - 可用主机号不能为全0或全1。

- **特殊地址**

  | 网络号 | 主机号          | 能否作为IP数据包源地址 | 能否作为IP数据包目的地址 | 用途                                     |
  | ------ | --------------- | ---------------------- | ------------------------ | ---------------------------------------- |
  | 全0    | 全0             | 可以                   | 不可以                   | 本网范围内表示主机，路由表中表示默认路由 |
  | 全0    | 特定值          | 不可以                 | 可以                     | 表示本网络内某个主机                     |
  | 全1    | 全1             | 不可以                 | 可以                     | 本网广播地址（路由器不转发）             |
  | 特定值 | 全0             | 不可以                 | 不可以                   | 表示一个特定网络                         |
  | 特定值 | 全1             | 不可以                 | 可以                     | 直接广播地址                             |
  | 127    | 非全0/1的任何数 | 可以                   | 可以                     | 环回地址，用于本机环回测试               |

#### 4.3.3 网络地址转换—NAT

- 网络地址转换(Network Address Translation)：指通过**将专用网络地址转换为公用地址**，从而对外隐藏内部管理的IP地址的技术。

- 优点：

  - **大大节省了IP地址的消耗**：整个专用网只需要一个全球IP地址就可以与因特网连通，并且专用网本地IP地址是可重用的。
  - 同时，它隐藏了内部网络结构，从而**降低了内部网络受到攻击的风险**。

- 私有IP地址

  - 只能用于 LAN，要想与外界交流，必须先通过网关将私有地址转换为公有地址。路由器对目的地址是私有IP地址的数据包一律不进行转发。

    | 地址类型 | 地址范围                      | 网段个数 | 每个网络的最大主机数 |
    | -------- | ----------------------------- | -------- | -------------------- |
    | A类      | 10.0.0.0 - 10.255.255.255     | 1        | 2^24 - 2             |
    | B类      | 172.16.0.0 - 172.31.255.255   | 16       | 2^16 - 2             |
    | C类      | 192.168.0.0 - 192.168.255.255 | 256      | 2^8 - 2              |

- **地址转换流程**：

  - 路由器保存有NAT转换表，存放{本地IP地址:端口}到{全球IP地址:端口}的映射。
  - 当私有网络内某个主机的进程要与外界通信时，NAT增加一个表项。
  - 当主机发送的数据包到达 NAT 路由器时，修改IP数据包的源地址为全球IP地址，TCP/UDP报文段的端口为对应端口。
  - 当 NAT 路由器接收到数据包时，查询NAT转换表，将数据包发往私有网络内的主机。

- 缺点：

  - 违反了IP的结构模型。IP的结构模型声明每个IP地址均唯一标识一台机器，而采用了NAT以后，允许多台机器使用同一私有IP。
    - 解决策略：路由器对目的地址是私有IP地址的数据包一律不进行转发。
  - NAT打破了Internet的端-端的连接模型，即任何一台主机可在任何时间给任何其他主机发送数据包。因为共有网络的主机无法主动与私有网络中的主机建立连接。
    - 解决策略：采用NAT穿越等技术。
  - 违反了最基本的协议分层规则。NAT使用了传输层中端口的概念。
  - 端口有限，每个地址至多只有65536台机器可以映射到同一IP地址中。

#### 4.3.4 子网划分与子网掩码、CIDR

- **子网划分**：在内部将一个网络块分成几个部分供多个内部网络使用，但对外仍像单个网络一样。
  - 动机：传统的两级IP地址（网络号+主机号）空间的利用率很低，而且不够灵活。
  - **三级IP地址结构：网络号 + 子网号 + 主机号**。
  - 注：目前是**支持子网号为全0或全1**，但是主机号不能为全0或全1。

- **子网掩码**：是一个长32bit的二进制串，用来指明一个 IP 地址的哪些位标识的是主机所在的网络。
  - 告诉主机或路由器对一个A类、B类、C类网络进行了子网划分，使用子网掩码来表达对原网络中主机号的借位。
  - 子网掩码是子网的重要属性，路由器的路由表中记录有目的网络的子网掩码。
- **无分类域间路由（Classless Inter-Domain Routing，CIDR）**
  - 动机：大量的网络地址导致了路由表爆炸，尤其对于 ISP 和骨干路由器。
  - **路由聚合（构成超网）**：将多个子网合并成一个较大的子网。因此在路由表中目的地址可以是较大的子网，使其能够匹配更大的地址空间。
  - 特点：
    - 消除了传统的A、B、C类地址及划分子网的概念。
    - 融合子网地址与子网掩码，方便子网划分。
  - 因为路由表中允许多个表项的前缀重叠，因此路由选择遵循**最长掩码匹配原则**，即当有多个目的网络匹配时，选择对应掩码最长的网络地址进行转发。

### 4.4 Internet的控制协议

- 参考资料：
  - [图解ARP协议（一）](https://zhuanlan.zhihu.com/p/28771785)
  - [Ping 的工作原理你懂了，那 ICMP 你懂不懂？](https://zhuanlan.zhihu.com/p/353060487)

- **地址解析协议(Address Resolution Protocol, ARP)**

  - 动机：无论网络层使用什么协议，**在实际网络的链路上传送数据帧时，最终必须使用硬件地址**，所以需要一种方法来完成IP地址到MAC地址的映射。
  - 每台主机都设有一个**ARP表**，用来存放本局域网上各主机和路由器的IP地址到MAC地址的映射表。使用ARP来动态维护此ARP表。
  - **作用：完成主机或路由器IP地址到MAC地址的映射，即询问目标IP对应的MAC地址**。
  - **ARP到底是链路层还是网络层？**强烈推荐看参考资料中的回答。
  - ![](D:\学习\计算机网络\img\arp报文格式.jpg)
    1. Hardware Type：表示硬件地址类型，一般为以太网；
    2. Protocol Type：表示三层协议地址类型，一般为IP；
    3. Hardware Length和Protocol Length：为MAC地址和IP地址的长度，单位是字节；
    4. Operation Code：指定了ARP报文的类型，包括ARP request和ARP reply，1表示请求，2表示回应；
    5. Source Hardware Address：指的是发送ARP报文的设备MAC地址；
    6. Source Protocol Address：指的是发送ARP报文的设备IP地址；
    7. Destination Hardware Address：指的是接收者MAC地址，在ARP request报文中，该字段值为0；
    8. Destination Protocol Address：指的是指接收者的IP地址。
  - **ARP原理之请求应答**
    - 发送**广播ARP请求分组**，同一局域网中的所有主机都将会收到该请求。该请求包含了如下信息：
      - 源主机的IP地址。
      - 源主机的MAC地址。
      - 目的主机的IP地址。
    - 目的主机收到请求后，在自己的ARP表中添加源主机的IP地址与MAC地址的映射，然后向源主机**单播ARP相应分组**。
    - 注：ARP请求不可能跨越局域网，因为路由器不会转发以太网级的广播报文。
  - [图解ARP协议（二）ARP攻击篇](https://zhuanlan.zhihu.com/p/28818627)
    - **ARP渗透（攻击）**：hacker通过伪造ARP回应分组，使局域网内其他主机的数据包都发往hacker。
      - 应用：断网攻击、流量被限、账号被窃。
      - 防御：[图解ARP协议（三）ARP防御篇-如何揪出"内鬼"并"优雅的还手"？](https://zhuanlan.zhihu.com/p/28865553)
  - **Gratuitous ARP**
    - [图解ARP协议（五）免费ARP：地址冲突了肿么办？](https://zhuanlan.zhihu.com/p/29011567)
    - **用于检测局域网内的IP地址冲突**。
    - 工作流程：
      - 主机在局域网中广播一个ARP请求查找自己的IP地址，如果收到回应，则表明两台主机被分配到了相同的IP地址。
  - **代理ARP**：当ARP请求目标跨网段时，网关设备收到此ARP请求，会用自己的MAC地址返回给请求者，这便是代理ARP（Proxy ARP）。
    - [图解ARP协议（四）代理ARP：善意的欺骗](https://zhuanlan.zhihu.com/p/28929126)
    - 代理ARP仅仅是正常ARP的一个拓展使用，是可选项而不是必要项；
    - 代理ARP有特定的应用场景，与网关/路由的设置有直接关系：
      - **当电脑没有配置网关/路由的IP地址时，并且需要跨网站通信时，ARP直接询问目标IP对应的MAC地址（跨网段），采用代理ARP**。
      - **否则ARP只需询问网关IP对应的MAC地址（同网段），采用正常ARP**。
    - **正常环境下，当用户接入网络时，都会通过DHCP协议或手工配置的方式得到IP和网关信息（所以不需要代理ARP）**。
    - 代理ARP会"受限于沿途网络设备"，真实网络里面一般都直接用ARP获取MAC地址。

- **动态主机配置协议(Dynamic Host Configuration Protocol, DHCP)**

  - 基于UDP的应用层协议。
  - 作用：用于为主机动态地分配私有IP地址。
  - 工作流程：
    - 需要IP地址的主机在启动时广播**DHCP发现报文**。
    - 只有DHCP服务器才回答此广播报文，然后从一个IP地址池中查找可用的IP地址，**广播DHCP提供报文**。
    - 主机收到服务器发送来的IP地址后，向广播免费ARP报文，查询该IP是否已被占用：
      - 如果没被占用，则广播**DHCP请求报文**。
      - 如果被占用，则广播**DHCP失败（Decline）报文**，然后重新通过DHCP获取新的IP。
    - DHCP服务器广播**DHCP确认报文**。

- **Internet控制消息协议（Internet Control Message Protocol，ICMP）**

  - 基于 IP 的网络层协议。

  - 主要功能：用于**IP 协议中发送控制消息**。

    - **确认 IP 包是否能够成功到达目标地址**

    - **网络诊断**

      - traceroute 程序用于显示两台互联网设备之间可能的路径并测量数据包在 IP 网络上的时延。
      - ping 程序是 traceroute 的简化版本，我们经常使用 ping 命令来测试两台设备之间是否互联，ping 通常用来测试两台主机之间的连接速度，并准确报告数据包到达目的地并返回后所花费的时间。

    - 通知类型

      - **差错报文**
        - **ICMP 目标不可达(类型 3)**
          - 当路由器无法将IP数据包发送给目标地址时发送。
          - 不可达信息的具体原因可以查看 ICMP 数据中的错误码。
        - **ICMP 重定向消息(类型 5)**
          - 如果路由器发现发送端主机使用了次优的路径发送数据，那么它会返回一个 `ICMP 重定向(ICMP Redirect Message)` 的消息给这个主机。
          - ICMP 重定向消息包含了最合适的**路由信息和源数据**。这种情况会发生在路由器持有更好的路由信息的情况下。
          - 优点：
            - 优化数据在网络中的转发路径；流量更快到达目的地。
            - 降低网络资源利用率，例如带宽和路由器 CPU 负载。
        - **ICMP 超时消息(类型 11)**
          - 在 IP 数据包中有一个叫做 **TTL(Time To Live, 生存周期)** ，它的值在每经过路由器一跳之后都会减 1，IP 数据包减为 0 时会被丢弃。此时，IP 路由器会发送一个 ICMP 超时消息(ICMP TIme Exceeded Message, 错误号 0)发送给主机，通知该包已经被丢弃。
          - 作用：防止路由器控制遇到问题发生循环状况时，避免 IP 包无休止的在网络上转发。
          - Traceroute (Tracert) 使用了 ICMP 超时消息报文。
          - 注意: PING工作在应用层，它直接使用网络层的ICMP，而未使用传输层的TCP或UDP。Traceroute/Tracert工作在网络层。
        - **ICMP 原点抑制消息(类型 4)**
          - 当发生某段网络拥堵时，可以向 IP 数据包的源地址发送一个 `ICMP 原点抑制(ICMP Source Quench Message)` 消息，收到这个消息的主机了解到线路某处发生了拥堵，从而抑制 IP 数据报的发送。
      - **查询报文**
        - **ICMP 回送消息(类型 0 和 类型 8)**
          - 作用：判断相互通信的主机之间是否连通，也就是判断所发送的数据包是否能够到达目标主机。
          - 网络上最常用的 ping 命令就是利用这个实现的。
        - **ICMP 路由器探索消息(类型 9、10)**
          - 主机会在任意路由连接组播的网络上发送一个 RS 消息，该网络的默认路由器会发送一个 RA 消息来作为默认路由的响应，接收到 RA 消息后，主机就会将该路由器作为默认路由器。
        - **ICMP 地址掩码消息(类型 17、18)**
          - 作用：用于主机或者路由器想要了解子网掩码的情况。
          - 可以向那些目标主机或路由器发送 `ICMP 地址掩码请求消息(ICMP Address Mask Request, 类型 17)` 和 `ICMP 地址掩码应答消息(ICMP Address Mask Reply, 类型 18)` 获取子网掩码信息。

      | 通知类型 | 分类     | 具体内容                            |
      | -------- | -------- | ----------------------------------- |
      | 0        | 查询报文 | 回送应答(Echo Reply)                |
      | 3        | 差错报文 | 目标不可达(Destination Unreachable) |
      | 4        | 差错报文 | 原点抑制(Source Quench)             |
      | 5        | 差错报文 | 重定向或改变路由(Redirect)          |
      | 8        | 查询报文 | 回送请求(Echo Request)              |
      | 9        | 查询报文 | 路由器公告(Router Advertisement)    |
      | 10       | 查询报文 | 路由器请求(Router Solicitation)     |
      | 11       | 差错报文 | ICMP超时(Time Exceeded)             |
      | 17       | 查询报文 | 地址子网请求(Address Mask Request)  |
      | 18       | 查询报文 | 地址子网应答(Address Mask Reply)    |

    - ICMP 在 IPv4 协议中的封装

    ![](D:\学习\计算机网络\img\ICMP 在 IPv4 协议中的封装.jpg)

    ![](D:\学习\计算机网络\img\ICMP格式.jpg)

    - ICMP 在 IPv6 协议中的封装
      - ICMP 头部包含了整个 ICMP 数据段的**校验和**

    ![](D:\学习\计算机网络\img\ICMP 在 IPv6 协议中的封装.jpg)

### 4.5 IPv6

- **动机：从根本上解决了IP地址的耗尽问题。**
  - 解决IP地址耗尽问题的措施有以下三种：
    - 采用无类别编址CIDR，使IP地址的分配更加合理。
    - 采用网络地址转换(NAT)方法以节省全球IP地址。
    - 采用具有更大地址空间的新版本的IPv6。

![](D:\学习\计算机网络\img\IPv6格式.png)

- IPv6 协议字段：
  - **版本**：与 IPv4 一样，版本号由 4 bit 构成，IPv6 版本号的值为 6。
  - **流量类型(Traffic Class)** 占用 8 bit，相当于 IPv4 中的服务类型(Type Of Service)。
  - **流标签(Flow Label)** 占用 20 bit。
    - 用于标识一条数据报的流，只有流标签、源地址和目标地址一致时，才会被认为是一个流。
    - 能够对一条流中的某些数据报给出优先权，或者它能够用来对来自某些应用的数据报给出更高的优先权。
  - **有效载荷长度(Payload Length)** 占用 16 bit，这 16 比特值作为一个无符号整数，表示数据部分的字节长度。
  - **下一个首部(Next Header)** 占用 8 bit，标识下一个扩展首部或上层协议首部。扩展首部算作有效载荷，位于数据部分。
  - **跳限制(Hop Limit)** 占用 8 bit，相当于 IPv4 的 TTL。数据每经过一次路由就会减 1，减到 0 则会丢弃数据。
  - **源地址(Source Address)** 占用 128 bit (8 个 16 位 )，表示发送端的 IP 地址。
  - **目标地址(Destination Address)** 占用 128 bit (8 个 16 位 )，表示接收端 IP 地址。
- 相较于 IPv4 ，IPv6 取消了下面几个字段：
  - **标识、标志和片偏移**：IPv6 不允许在中间路由器上进行分片和重新组装。这种操作只能在端系统上进行，IPv6 将这个功能放在端系统中，加快了网络中的转发速度。
  - **首部校验和**：因为在运输层和数据链路执行了报文段完整性校验工作，IP 设计者大概觉得在网络层中有首部校验和比较多余，所以去掉了。**IP 更多专注的是快速处理分组数据**。
  - **选项字段**：选项字段不再是标准 IP 首部的一部分了，但是它并没有消失，而是可能出现在 IPv6 的扩展首部，也就是下一个首部中。
  - 协议 ---> 下一个首部。
  - 总长度 ---> 有效载荷长度。
  - 服务类型 ---> 流量类型。
- 对 IPv4 的改进：
  - **地址空间变得更大**：这是 IPv6 最主要的一个特点，即支持更大的地址空间。
  - **精简报文结构**: IPv6 要比 IPv4 精简很多，IPv4 的报文长度不固定，而且有一个不断变化的选项字段；IPv6 报文段固定，并且将选项字段，分片的字段移到了 IPv6 扩展头中，这就极大的精简了 IPv6 的报文结构。
  - **实现了自动配置**：IPv6 支持其主机设备的**状态和无状态**自动配置模式，不需要 DHCP 协议。
  - **层次化的网络结构**：IPv6 不再像 IPv4 一样按照 A、B、C等分类来划分地址，而是通过 IANA -> RIR -> ISP 这样的顺序来分配的。IANA 是国际互联网号码分配机构，RIR 是区域互联网注册管理机构，ISP 是一些运营商（例如电信、移动、联通）。
  - **IPSec**：IPv6 的扩展报头中有一个认证报头、封装安全净载报头，这两个报头是 IPsec 定义的。通过这两个报头网络层自己就可以实现端到端的安全，而无需像 IPv4 协议一样需要其他协议的帮助。
  - **支持任播**：IPv6 引入了一种新的寻址方式，称为任播寻址。任播的目的站是-组计算机，但数据报在交付时只交付其中的一台计算机，通常是距离最近的一台计算机。
- **IPv6 地址**
  - 采用**冒分十六进制**表示。
  - 将 128 比特的 IP 地址以每 16 比特为一组，并用 `:` 号进行分隔。
  - 如果出现连续的 0 时还可以将 0 省略，并用 `::` 两个冒号隔开，一个 IP 地址只允许出现一次两个连续的冒号。
- **IPV6向IPV4过滤的策略**
  - 双栈协议：在一台设备上同时启用IPv4协议栈和IPv6协议栈，这样就能同时接收IPv4和IPv6数据包。
  - 隧道技术：将IPv6数据包重新封装后通过隧道发送。

### 4.6 拥塞控制

- **拥塞的定义**：网络中存在太多的数据包导致数据包被延迟和丢失，从而降低了传输性能的情况。

- 拥塞控制的任务：
  - 确保网络能够承载所有到达的流量，这是一个全局性的问题。
  - 网络层和传输层共同承担拥塞控制的任务。
  - Nagle 指出如果路由器拥有无限内存，拥塞的情况将会更加糟糕。

- 拥塞控制与流量控制的区别：
  - 流量控制指在特定的发送方和接收方之间的点到点流量的控制，确保一个快速的发送方不会持续地以超过接收方接收能力的速率传输数据。
  - 拥塞控制确保网络能够承载所有到达的流量，这是一个全局性的问题。

- **拥塞控制的方法**：
  - **增加网络供给**
    - 升级链路和路由器、购买带宽。
  - **流量感知路由**
    - 根据动态变化的链路状态进行路由选择。
  - **准入控制**
    - 基本思想：除非网络可以携带额外的流量而不会变得拥塞，否则不再建立新的虚电路。
    - 描述流量的方法：漏桶、令牌桶
    - 估计网络能承载的虚电路数量：
      - 由历史数据捕获数据传送的统计特征，从而估计准入的虚电路数量。
  - **流量限制**
    - 当拥塞迫在眉睫时，网络要求发送端抑制发送流量。
    - 步骤：
      - 路由器必须确定何时将要拥塞，可以考虑利用以下数据：
        - 输出线路的利用率（没有考虑流量的突发性，因此不考虑该指标）
        - 丢失的数据包数量（缺少及时性，因此不考虑该指标）
        - 在路由器内缓冲的排队数据包（最有用）
      - 利用指数加权移动平均，得到路由器内部的排队延迟：`d_new = a * d_old + (1-a) * s`。其中，d 表示排队延迟估计，s 表示瞬时队列的长度。
      - 路由器必须及时把反馈信息传递给造成拥塞的发送方。可以向源地址发送**ICMP 原点抑制(ICMP Source Quench Message)**消息，收到这个消息的主机了解到线路某处发生了拥堵，从而抑制 IP 数据报的发送。
  - **负载脱落**
    - 当路由器不得不丢弃数据包时，根据策略选择某些数据包丢弃。
    - 例子：
      - 对于文件传输，旧的数据包价值高于新的数据包。此时应采取**尾部丢弃策略**。
      - 对于实时媒体流，新的数据包价值高于旧的数据包。
      - 携带路由信息的数据包更重要。
    - 随机早期检测
      - 动机：大多数主机从网络能获取的唯一可靠的拥塞迹象是丢包。
      - **适用于 TCP 传输协议（数据报网络）。**
      - 算法步骤：
        - 当路由器的平均队列长度超过某个阈值时，路由器随机丢弃一小部分的数据包。
        - 发送方因为没有收到确认信息，认为发生了丢包。
        - TCP 协议的滑动窗口机制起作用，放缓发送速度。
        - 因此，网络的拥塞得到一定程度的缓解。

## 第 5 章 传输层

### 5.1 传输层提供的服务

- 主要功能：**负责主机中两个进程之间的通信**，为**端到端**连接提供可靠的传输服务。

  - 差错控制
  - 流量控制
  - 拥塞控制
  - 服务质量

- 传输层的寻址与端口

  - **端口**：**传输层服务访问点 (TSAP)**，应用进程通过端口将**报文**向下交付给传输层，传输层通过端口将**报文段**向上交付给应用进程。

  - **端口映射器**：存储服务名与端口号之间的映射。

    - 客户端首先与端口映射器建立连接，得到服务名对应的端口。
    - 最后释放与端口映射器的连接，与所需的服务建立一个新的连接。

  - **进程服务器**（UNIX中的inetd）：在同一时间监听一组端口。

    - 客户端请求与某一端口建立连接时，若当前端口没有服务器在监听，则会与进程服务器建立连接。
    - 进程服务器将派生出被请求的服务器，允许该服务器继承与用户的现有连接。
    - 新服务器释放连接后，进程服务器重新继续监听一组端口。

  - 端口号的分类：

    - 服务端使用

      - **熟知端口号**：0-1023
      - 登记端口号：1024-49151

    - 客户端使用

      - 49152-65535

        | 应用程序   | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP |
        | ---------- | ---- | ------ | ---- | ---- | ---- | ---- | ---- |
        | 熟知端口号 | 21   | 23     | 25   | 53   | 69   | 80   | 161  |

  - 套接字：进行网络数据传输的软件设备。

### 5.2 用户数据报协议 UDP

- 特点：
  - **无连接**、不可靠
    - **传输速率高**：不引入建立连接的时延。
    - **维护开销小**：无连接意味着不需要存储缓存、拥塞控制参数、序号、确认号等。
    - UDP 不保证可靠交付，但是应用层可以灵活设计自己的可靠性机制。
    - 适合一次性传输少量数据的网络应用。
  - **无拥塞控制**
    - **应用层能更好地控制要发送的数据和发送时间**，因为网络即时发生了拥塞，主机照样发送数据。
    - 适合实时性要求高应用，能容忍数据丢失，但不允许较长的时延。
  - UDP 首部开销少，只有 8B。
  - **面向报文**：发送方 UDP 对应用层交下来的报文，在添加首部后就向下交付给 IP 层，**既不合并，也不拆分**，而是保留这些报文的边界。
    - 因此报文是 UDP 数据报处理的最小单位。
    - 因此，应用程序必须选择合适大小的报文。若报文太长，则 IP 层需要分片，降低效率。若太短，会使 IP 数据报太短。
- **应用**：
  - DNS 域名系统。

![](img\UDP首部格式.png)

- **UDP 首部格式**

  - 源端口。源端口号。在需要对方回信时选用，不需要时可用全0。
  - 目的端口。目的端口号。这在终点交付报文时必须使用到。
  - 长度。UDP 数据报的长度(包括首部和数据)，其最小值是8 (仅有首部)。
  - 校验和。检测 UDP 数据报在传输中是否有错。有错就丢弃。该字段是可选的，当源主机不想计算校验和时，则直接令该字段为全0。
    - 伪首部和全0字节是不发送的，仅供校验使用。

  ![](img\20UDP校验.png)

### 5.3 TCP协议

参考资料：

- [彻底搞懂TCP协议：从 TCP 三次握手四次挥手说起](https://zhuanlan.zhihu.com/p/199284611)
- [30张图解： TCP 重传、滑动窗口、流量控制、拥塞控制发愁](https://zhuanlan.zhihu.com/p/133307545)

#### 5.3.1 TCP协议特点

- **面向（虚）连接的传输层协议**。
- 提供可靠交付的服务，**可靠有序、不丢不重**。
- 所有的TCP连接都是**点到点**的。
- 支持**全双工**通信。
- **面向字节流**，不保留信息的边界。

- TCP传送的数据单元称为**报文段**，整个TCP报文段作为IP数据报的数据部分封装在IP数据报中。

#### 5.3.2 TCP 的服务模型

- TCP服务由发送端和接收端创建一种称为**套接字（socket）**的端点来获得。
- 每一个套接字有一个套接字编号（地址），该编号由主机的IP地址以及一个本地主机的16位端口号组成。
- 为了获得TCP服务，必须显式在两台主机的套接字之间建立一个连接。
- **通信五元组**：（协议、源IP、源端口、目的IP、目的端口）

#### 5.3.3 TCP报文段的首部格式

TCP报文段包含一个固定格式的 20B 的头，后面根据需要而增加的选项字段，不足4B整数倍时使用0填充。

![](D:\学习\计算机网络\img\TCP格式.png)
- **源端口和目的端口**。各占2B。端口是运输层与应用层的服务接口，运输层的复用和分用功能都要通过端口实现。
- **序号**。占4B。指的是本报文段所发送的数据的第一个字节的序号。
  - TCP是面向字节流的，所以TCP连接传送的数据流中的每个字节都编上一个序号。
- **确认号**。占4B，指下一个期待的字节。
  - 若确认号为N，则表明到序号N- 1为止的所有数据都已正确收到。
- **TCP头长度**：占4位，指明TCP头的长度，单位为4B。
  - 因此当此字段的值为15时，达到TCP首部的最大长度60B。
- 保留字段。占6位，保留为今后使用，但目前应置为0，该字段可以忽略不计。
- **8个1比特的标志位**：
  - CWR、ECE作用拥塞控制的信号。
  - 紧急位URG。URG= 1时，表明紧急指针字段有效。它告诉系统报文段中有紧急数据，应尽快传送(相当于高优先级的数据)。
    - URG需要和紧急指针配套使用，数据从第一个字节到紧急指针所指字节就是紧急数据。
  - **确认位ACK**。只有当ACK= 1时确认号字段才有效。当ACK=0时，确认号无效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置1。
  - 推送位PSH (Push)。 接收TCP收到PSH= 1的报文段，就尽快地交付给接收应用进程而不再等到整个缓存都填满后再向上交付。
  - 复位位RST (Reset)。RST=1时，表明TCP连接中出现严重差错(如主机崩溃或其他原因)，必须释放连接，然后再重新建立运输连接。
  - **同步位SYN**。同步SYN= 1表示这是一个**连接请求**或**连接接收**报文。
    - 当SYN=1, ACK=0时，表明这是一个**连接请求**报文，。
    - 若同意建立连接，则在响应报文中使用SYN=1, ACK=1，表明这是一个**连接接收**报文。
  - **终止位FIN (Finish)**。用来**释放一个连接**。FIN= 1表明此报文段的发送方的数据已发送完毕，并要求释放传输连接。
- **窗口大小。占2B，单位是 B。**指定从被确认的字节算起可以发送的字节数**，接收方的数据缓存空间是有限的，因此用窗口值作为接收方让发送方设置其发送窗口的依据。
- **校验和**。占2B。检验范围包括首部、数据、伪首部。在计算校验和时，和UDP一样，要在TCP报文段的前面加上12B的伪首部（只需将UDP伪首部的第4个字段，即协议字段的17改成6，其他的和UDP一样）。
- **紧急指针**。占16 位，指出在本报文段中紧急数据共有多少字节（紧急数据放在本报文段数据的最前面）。
- **选项**。长度可变。
  - **最大报文段长度（Maximum SegmentSize，MSS）**。MSS是TCP报文段中的数据字段的最大长度。
  - **窗口尺度（Window Scale）**：因为窗口大小字段只有16B，所以最大值为64KB，然而64KB还是太小了，该选项可弥补此不足。**窗口尺度允许发送端和接收端在连接建立阶段协商窗口尺度因此，可使从窗口大小向左移动至多14位**，因此允许窗口最大可达1GB。
  - **时间戳**：携带由发送端发出的时间戳。
  - **选择确认（SACK，Selective ACKnowledgement）**：是确认号的补充， 使得接收端可以告诉发送端已经接收到段的序号范围。
- 填充：为了使整个首部长度是4B的整数倍。

#### 5.3.4 TCP连接管理

- **TCP连接建立需要解决的问题**：
  - 要使每一方都能够确知对方的存在。
  - 要允许双方协商一些参数(如最大窗口值、是否使用窗口扩大选项、时间戳选项及服务质量等)。
  - 能够对运输实体资源( 如缓存大小、连接表中的项目等)进行分配。
- **三次握手、四次挥手工作流程**：

![](D:\学习\计算机网络\img\TCP工作流程.jpg)

![](D:\学习\计算机网络\img\TCP连接管理.png)

- TCP连接解决**延迟重复**问题
  - 描述：旧的重复请求经过一段时间后达到接收端，导致接收端处理了旧的请求。
  - 思想：**源端用序号作为段的标签，使得该段在T秒内不被重用，同时进行三次握手检查连接请求的正确性**。
  - RFC793 中，建议初始化序列号（ISN，Inital Sequence Number） 和日时钟绑在一起，这个时钟会在每 4 微秒对 ISN 做加一操作，直到超过 2^32，又从 0 开始，这需要 4 小时才会产生 ISN 的回绕问题，这几乎可以保证每个新连接的 ISN 不会和旧的连接的 ISN 产生冲突。基于时钟的 ISN很容易让攻击者猜测到 TCP 连接的 ISN。
  - RFC1323 中，使用了**防止序号回绕**（PAWS，Protection Against Wrapped Sequence number），使用TCP选项中的时间戳字段来辅助32为序号，使得 ISN 是在一个基准值的基础上进行随机选取的。
- 初始化连接的 SYN 超时问题——**SYN泛洪攻击**
  - 攻击者发送TCP SYN，当服务器返回ACK后，攻击者不对其进行确认。
  - 这个TCP就会一直占用 Server 的 SYN 连接队列中的一个位置，大量这样的连接就会将 Server 的 SYN 连接队列耗尽，让正常的连接无法得到处理。
  - Linux 下默认会进行 5 次重发 SYN-ACK 包，重试的间隔时间从 1s 开始，下次的重试间隔时间是前一次的双倍，5 次的重试时间间隔为 1s、2s、4s、8s、16s，总共 31s，第 5 次发出后还要等 32s 都知道第 5 次也超时了，所以，总共需要 1s + 2s +4s+ 8s+ 16s + 32s = 63s，TCP 才会把断开这个连接。
  - 应对措施：linux 提供了几个 TCP 参数：tcp_syncookies、tcp_synack_retries、tcp_max_syn_backlog、tcp_abort_on_overflow 来调整应对。
- TCP 的 Peer 两端同时断开连接
  - 两端 Peer 可能出现完全一样的状态转移 FIN_WAIT1——>CLOSEING——->TIME_WAIT，也就会 Client 和 Server 最后同时进入 TIME_WAIT 状态。

![](D:\学习\计算机网络\img\TCP 的 Peer 两端同时断开连接.png)

- 四次挥手能不能变成三次挥手呢？
  - 四次挥手是确保双方都传输了所有的数据后，才各自发送 FIN 请求。
  - 如果 Server 在收到 Client 的 FIN 包后，在也没数据需要发送给 Client 了，那么对 Client 的 ACK 包和 Server 自己的 FIN 包就可以合并成为一个包发送过去，这样四次挥手就可以变成三次了。

- **TIME_WAIT 状态**
  - 处于 TIME_WAIT 状态的主机会短时间内保留连接信息。
  - 作用：主动关闭方需要进入 TIME_WAIT 以便能够重发丢掉的被动关闭方 FIN 包的 ACK。
  - 缺陷：
    - 作为服务器，短时间内关闭了大量的 Client 连接，就会造成服务器上出现大量的 TIME_WAIT 连接，占据大量的 tuple，严重消耗着服务器的资源。
    - 作为客户端，短时间内大量的短连接，会大量消耗的 Client 机器的端口，毕竟端口只有 65535 个，端口被耗尽了，后续就无法在发起新的连接了。
  - 改进：
    - TIME_WAIT 的快速回收和重用

- **TCP 的延迟确认机制**

  - 在收到数据后并不马上确认，而是延迟一段可以接受的时间，以便将ACK与要发送的数据一起发送出去。
  - 同时，如果收到了按序的两个包，只需要对第二个包确认即可。
  - 作用：提高网络利用率。
  - TCP 连接的延迟确认时间一般初始化为最小值 40ms，随后根据连接的重传超时时间（RTO）、上次收到数据包与本次接收数据包的时间间隔等参数进行不断调整。

- **TCP 的重传机制以及重传的超时计算**

  - TCP的重传机制包括：
    - 快速重传：在连续收到 3 次相同确认号的 Duplicate ACK，那么就进行重传，而不需要等待重传计时器超时。在后文的拥塞控制中会详细介绍。
    - 超时重传：当包发送出去经过了 RTO（Retransmission TimeOut）值的时间后，依旧没有收到确认，则进行重传。
  - RTO 随着网络的状况在变化的，因此需要不断进行调整。
  - RFC793 中定义了一个经典算法（指数加权移动平均算法），只需要知道RTT，就可以计算 RTO。

  ```
  [1] 首先采样计算RTT值
  [2] 然后计算平滑的RTT，称为Smoothed Round Trip Time (SRTT)，SRTT = ( ALPHA * SRTT ) + ((1-ALPHA) * RTT)
  [3] RTO = min[UBOUND,max[LBOUND,(BETA*SRTT)]]
  ```

  - RFC793 算法的缺陷：
    - 如果计算 RTT 是用第一次发数据的时间和 ack 回来的时间做 RTT 样本值，得到的 RTT 值就会偏大。对应下图（a）。
    - 如果用重传的时间和 ACK 回来的时间做 RTT 样本值，得到的 RTT 值就会偏小。对应下图（b）。

  ![](D:\学习\计算机网络\img\RFC793 重传机制.jpg)
  - 因此，现在采用的是 Jacobson / Karels Algorithm（参看 FC6289），这个算法的核心是：除了考虑每两次测量值的偏差之外，其变化率也应该考虑在内，如果变化率过大，则通过以变化率为自变量的函数为主计算 RTT(如果陡然增大，则取值为比较大的正数，如果陡然减小，则取值为比较小的负数，然后和平均值加权求和)，反之如果变化率很小，则取测量平均值。

  ```text
  SRTT = SRTT + α (RTT – SRTT)  —— 计算平滑RTT
  DevRTT = (1-β)*DevRTT + β*(|RTT-SRTT|) ——计算平滑RTT和真实的差距（加权移动平均）
  RTO= µ * SRTT + ∂ *DevRTT —— 神一样的公式
  （其中：在Linux下，α = 0.125，β = 0.25， μ = 1，∂ = 4 ——这就是算法中的“调得一手好参数”，nobody knows why, it just works…） 最后的这个算法在被用在今天的TCP协议中并工作非常好
  ```

  - **重传计时器**的设计
    - 方案一：为 TCP 中的每一个数据包维护一个定时器，在这个定时器到期前没收到确认，则进行重传。
      - 缺陷：将会存在非常多的定时器，会带来巨大内存开销和调度开销。
    - 因此采用方案二：为 TCP 中的每一连接维护一个定时器。
    - 算法流程：
      - 每次包含数据的包被发送（包括重发），如果还没开启重传定时器，则开启它，使得它在 RTO 秒之后超时（按照当前的 RTO 值）。 
      - 当接收到一个 ACK 确认一个新的数据， 如果所有的发出数据都被确认了，关闭重传定时器。
      - 当接收到一个 ACK 确认一个新的数据，还有数据在传输，也就是还有没被确认的数据，重新设置重传定时器，为当前的 RTO 值。
      - 当重传定时器超时后，依次做下列 3 件事情： 
        - 重传最早的尚未被 TCP 接收方 ACK 的数据包。 
        - 重新设置 RTO 为 RTO *2（“还原定时器”），但是新 RTO 不应该超过 RTO 的上限。
        - 重启重传定时器。
  - **选择确认（SACK）机制**
    - RFC2018 提出了 Selective Acknowledgment（SACK，选择确认）机制，接收端可以告知发送端成功接收了哪些包。
    - 在 TCP 头部「选项」字段里加一个 `SACK` 的东西，它**可以将缓存的地图发送给发送方**，这样发送方就可以知道哪些数据收到了，哪些数据没收到，知道了这些信息，就可以**只重传丢失的数据**。

  ![](D:\学习\计算机网络\img\SACK.jpg)

- **TCP 流量控制——TCP 滑动窗口**
  - TCP 的窗口(window)是一个 16bit 位字段，它代表的是接收窗口的字节容量，最大值为 64KB。
  - 另外在 TCP 的选项字段中还包含了一个 TCP 窗口扩大因子，option-kind 为 3，option-length 为 3 个字节，option-data 取值范围 0-14。窗口扩大因子用来扩大 TCP 窗口，可把原来 16bit 的窗口，扩大为 31bit。
  - 在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，这称为**接收窗口rwnd**，即调整TCP报文段首部中的“窗口”字段值，来限制发送方向网络注入报文的速率。
  - **窗口探测**：发送端在接收窗口变成 0 后，会发送**窗口探测 ( Window probe ) 报文**给接收方，来探测目前接收端的窗口大小。
    - TCP 为每个连接设有一个持续定时器，**只要 TCP 连接一方收到对方的零窗口通知，就启动持续计时器。**
    - 如果持续计时器超时，就会发送**窗口探测 ( Window probe ) 报文**，而对方在确认这个探测报文时，给出自己现在的接收窗口大小。
  - **低能窗口综合征（Silly Window Syndrome）**：频繁发送大量小包。
    - 原因一：接收端一直在通知一个小的窗口。
      - 解决方法：**David D Clark’s 方案**。如果收到的数据导致 window size 小于某个值，就 ACK 一个 0 窗口，阻止发送端再发数据过来。等到接收端处理了一些数据后 windows size 大于等于了 MSS，或者 buffer 有一半为空，才通告一个非 0 窗口。
    - 原因二：发送端本身问题，一直在发送小包。
      - 解决方法：**Nagle’s 算法**，思路是让发送端积累一定的数据后再发送。算法流程如下：
        1. 如果包长度达到 MSS ，则允许发送。
        2. 如果该包含有 FIN ，则允许发送。
        3. 设置了 TCP_NODELAY 选项，则允许发送。
        4. 设置 TCP_CORK 选项时，若所有发出去的小数据包（包长度小于 MSS）均被确认，则允许发送。
        5. 上述条件都未满足，但发生了超时（一般为 200ms ），则立即发送。
      - 规则[4]指出 TCP 连接上最多只能有一个未被确认的小数据包。从规则[4]可以看出 Nagle 算法并不禁止发送小的数据包（超时时间内），而是避免发送大量小的数据包。
      - 使用场合：适用于小包、高延迟的场合。
      - 优点：提高信道利用率。
      - 缺点：导致交互速度严重下降。
  - **传输层和数据链路层的流量控制的区别**
    - 传输层定义端到端用户之间的流量控制，数据链路层定义两个中间的相邻结点的流量控制。
    - 另外，数据链路层的滑动窗口协议的窗口大小不能动态变化，传输层的则可以动态变化。
- **TCP 的计时器**
  - 重传计时器（RTO，Retransmission TimeOut），详细介绍见上文的**TCP 的重传机制**。
  - 持续计时器（Persistence timer），用于窗口探询。
  - 保活计时器（keepalive timer），当一个连接空闲了较长一段时间后，保活计时器超时，促使某一端查看另一端是否仍然存在。

- **TCP 拥塞控制**

  - 拥塞控制，是指防止过多的数据注入网络，保证网络中的路由器或链路不致过载。
  - 拥塞控制与流量控制的区别
    - 拥塞控制是让网络能够承受现有的网络负荷，是一个全局性的过程，涉及所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。
    - 流量控制往往是指点对点的通信量的控制，即接收端控制发送端，它所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。
  - TCP 拥塞控制的目标：
    - 强调公平性。
    - 注重拥塞过后的恢复。
  - Reno 算法包含 4 个部分：
    - 慢热启动算法 – Slow Start；
    - 拥塞避免算法 – Congestion Avoidance；
    - 快速重传 - Fast Retransimit；
    - 快速恢复算法 – Fast Recovery。
  - **慢热启动算法 – Slow Start**
    - 连接建好的开始先初始化 cwnd = N，表明可以传 N 个 MSS 大小的数据。
    - 每当收到一个 ACK，++cwnd; 呈线性上升。
    - 每当过了一个 RTT，cwnd = cwnd*2; 呈指数上升。
    - 还有一个慢启动门限 ssthresh（slow start threshold），是一个上限，当 cwnd >= ssthresh 时，就会进入"拥塞避免算法 - Congestion Avoidance"。
  - **拥塞避免算法 – Congestion Avoidance**
    - 每收到一个 ACK，调整 cwnd 为 (cwnd + 1/cwnd) * MSS 个字节。
    - 每经过一个 RTT 的时长，cwnd 增加 1 个 MSS 大小。
  - 发生重传的两种情况：
    - RTO 超时重传。这种情况下，TCP 就认为出现拥塞的可能性就很大，于是它反应非常强烈。
      - 调整门限 ssthresh 的值为当前 cwnd 值的 1/2。
      - reset 自己的 cwnd 值为 1。
      - 重新进入慢启动过程。
    - 在 RTO 超时前，收到 3 个 Duplicate ACK 进行重传数据包。这种情况下，收到 3 个冗余 ACK 后说明确实有中间的分段丢失，然而后面的分段确实到达了接收端，因为这样才会发送冗余 ACK，这一般是路由器故障或者轻度拥塞或者其它不太严重的原因引起的，因此此时拥塞窗口缩小的幅度就不能太大，此时进入快速重传。
  - **快速重传 - Fast Retransmit**
    - 调整门限 ssthresh 的值为当前 cwnd 值的 1/2。
    - 将 cwnd 值设置为新的 ssthresh 的值。
    - 进入快速恢复阶段。

  - **快速恢复算法 – Fast Recovery**
    - 在进入快速恢复前，cwnd 和 sshthresh 已被更新为：sshthresh = cwnd /2，cwnd = sshthresh。
    - 把 cwnd 设置为 ssthresh + 3，重传 Duplicated ACKs 指定的数据包。
    - 如果再收到 duplicated Acks，那么 cwnd = cwnd +1。
    - 如果收到新的 ACK，而非 duplicated Ack，那么将 cwnd 重新设置为【快速重传】中 sshthresh 的值。
    - 进入拥塞避免状态。
  - 拥塞控制在拥塞避免阶段，cwnd 是加性增加的，在判断出现拥塞的时候采取的是指数递减。
    - 符合公平性的原则，拥塞窗口的增加受惠的只是自己，而拥塞窗口减少受益的是大家。

  - TCP 的发送窗口的三种稳定状态：
    - **接收端拥有大窗口的经典锯齿状**
      - 用慢启动或者拥塞避免方式不断增加其拥塞窗口，直到丢包的发生。
      - 如果发生超时丢包，则进入慢启动阶段。
      - 如果发生冗余ACK丢包， 则依次进入快速重传、快速恢复、拥塞避免阶段。

    ![](D:\学习\计算机网络\img\TCP拥塞控制.jpg)

    - **接收端拥有小窗口的直线状态**
      - 如果接受窗口一直很小，那么发送窗口就稳定等于接收窗口，呈直线状态。
    - **两个直连网络端点间的满载状态下的直线状态**

## 第 6 章 应用层

### 6.1 网络应用模型

- 客户/服务器模型（C/S）
  - 服务器：提供计算服务的设备。
    - 永久提供服务
    - 永久性访问地址/域名
  - 客户机：请求计算服务的主机。
    - 与服务器通信，使用服务器提供的服务
    - 间歇性接入网络
    - 可能使用动态IP地址
    - 不与其他客户机直接通信
- P2P模型
  - 在P2P模型中，各计算机没有固定的客户和服务器划分。相反，任意一一对计算机一称为**对等方(Peer)**， 直接相互通信。
  - 每个结点既作为客户访问其他结点的资源，也作为服务器提供资源给其他结点访问。
  - 优点：
    - 减轻了服务器的计算压力，消除了对某个服务器的完全依赖，可以将任务分配到各个结点上，因此大大提高了系统效率和资源利用率（例如，播放流媒体时对服务器的压力过大，而通过P2P模型，可以利用大量的客户机来提供服务）。
    - 多个客户机之间可以直接共享文档。
    - 可扩展性好，传统服务器有响应和带宽的限制，因此只能接受一定数量的请求。
    - 网络健壮性强，单个结点的失效不会影响其他部分的结点。
  - 缺点：
    - 在获取服务的同时,还要给其他结点提供服务，因此会占用较多的内存，影响整机速度。
    - 例如，经常进行P2P下载还会对硬盘造成较大的损伤。
    - 据某互联网调研机构统计，当前P2P程序已占互联网50%~90%的流量，使网络变得非常拥塞，因此各大ISP (互联网服务2提供商，如电信、网通等)通常都对P2P应用持反对态度。

### 6.2 域名系统DNS

- DNS 是 Internet 使用的命名系统，用于将具有特定含义的主机名转换为IP地址。

- DNS 采用客户/服务器模型，基于 UDP 协议，端口号是 53。
- 因特网采用**层次树状结构**的命名方法。采用这种命名方法，任何一个连接到因特网的主机或路由器，都有一个唯一的层次结构名称，即域名(Domain Name)。
- 在域名系统中，每个域分别由不同的组织进行管理。每个组织都可以将它的域再分成一定数目的子域，并将这些子域委托给其他组织去管理。
- 域名命名规则：
  - 标号中的英文不区分大小写。.
  - 标号中除连字符(-) 外不能使用其他的标点符号。
  - 每个标号不超过63个字符，多标号组成的完整域名最长不超过255个字符。
  - 级别最低的域名写在最左边，级别最高的顶级域名写在最右边。

- 顶级域名(Top Level Domain, TLD)分为如下三大类:
  - 国家顶级域名(nTLD)。国家和某些地区的域名，如“.cn”表示中国，“.us”表示美国，.uk”表示英国。
  - 通用顶级域名(gTLD)。 常见的有“.com” (公司)、“.net" (网络服务机构)、“.org”(非营利性组织)和“.gov" (国家或政府部门)等。
  - 基础结构域名。这种顶级域名只有一个，即arpa，用于反向域名解析，因此又称反向域名。反向域名解析与通常的正向域名解析相反，提供IP地址到域名的对应，反向域名格式如：X.X.X.in-addr.arpa。很多网络服务提供商要求访问的IP地址具有反向域名解析的结果，否则不提供服务。
- **域名服务器**
  - 因特网的域名系统被设计成一个联机分布式的数据库系统，并采用客户/服务器模型。
  - 主要有4种类型的域名服务器：
    - 根域名服务器
      - 根域名服务器是最高层次的域名服务器，所有的根域名服务器都知道所有的顶级域名服务器的IP地址。
      - 因特网上有13个根域名服务器，整体构成集群，以提供安全性和可靠性。
      - 不直接将待查询的域名直接转换为IP地址，而是提供相应的顶级域名服务器的地址。
    - 顶级域名服务器
      - 管理在该顶级域名服务器注册的所有二级域名。
      - 可能将待查询的域名直接转换为IP地址，也可能提供下一步应对查找的域名服务器的IP地址。
    - 授权域名服务器(权限域名服务器)
      - 每台主机都必须在授权域名服务器处登记。为了更加可靠地工作，一台主机最好至少有两个授权域名服务器。
      - 实际上，许多域名服务器都同时充当本地域名服务器和授权域名服务器。
      - 授权域名服务器总能将其管辖的主机名转换为该主机的IP地址。
    - 本地域名服务器
      - 当一台主机发出DNS查询请求时，这个查询请求报文就发送给该主机的本地域名服务器。

- **域名解析过程**

  - 域名解析：

    - 正向解析：把**域名映射成IP地址**的过程。
    - 反向解析：把**IP地址映射成域名**的过程。

  - 当客户端需要域名解析时，通过本机的DNS客户端构造一个**DNS请求报文**，以**UDP数据报**方式发往本地域名服务器。

  - 域名解析有两种方式：

    - **递归查询方式**：由于该方法给根域名服务造成的负载过大，所以在实际中几乎不使用。

    ![](D:\学习\计算机网络\img\DNS递归查询方式.png)

    - **递归与迭代相结合的查询方式**
      - 主机向本地域名服务器的查询采用的是递归查询。
      - 本地域名服务器向根域名服务器的查询采用迭代查询。

    ![](D:\学习\计算机网络\img\DNS递归与迭代相结合的查询方式.png)

  - **域名解析过程**：假定某客户机想获知域名为y.abc.com主机的IP地址，域名解析的过程(共使用8个UDP报文)如下：

    1. 客户机向其**本地域名服务器**发出DNS请求报文。
    2. 本地域名服务器收到请求后，**查询本地缓存**，若没有该记录，则以DNS客户的身份向**根域名服务器**发出解析请求。
    3. 根域名服务器收到请求后，判断该域名属于.com域，将对应的**顶级域名服务器**dns.com的IP地址返回给本地域名服务器。
    4. 本地域名服务器向顶级域名服务器dns.com发出解析请求报文。
    5. 顶级域名服务器dns.com收到请求后，判断该域名属于abc.com域，因此将对应的**授权域名服务器**dns.abc.com的IP地址返回给本地域名服务器。
    6. 本地域名服务器向授权域名服务器dns.abc.com发起解析请求报文。
    7. 授权域名服务器dns.abc.com收到请求后，将查询结果返回给本地域名服务器。
    8. 本地域名服务器**将查询结果保存到本地缓存**，同时返回给客户机。

- DNS 缓存

  - 为了提高DNS的查询效率，并减少因特网上的DNS查询报文数量，在域名服务器中广泛地使用了高速缓存。
  - 当一个DNS服务器接收到DNS查询结果时，它能将该DNS信息缓存在高速缓存中。
  - 因为主机名和IP地址之间的映射不是永久的，所以DNS服务器将在一段时间后丢弃高速缓存中的信息。

### 6.3 FTP协议

- 文件传输协议( File Transfer Protocol, FTP)是因特网上使用得最广泛的文件传输协议。
- FTP采用**客户/服务器（C/S）**的工作方式，基于**TCP可靠的传输服务**。
- FTP提供交互式的访问，允许客户指明文件的类型与格式，并**允许文件具有存取权限**。
- 它屏蔽了各计算机系统的细节，因而适合于在异构网络中的任意计算机之间传送文件。
- 功能：
  - 提供不同种类主机系统(硬、软件体系等都可以不同)之间的文件传输能力。
  - 一个FTP服务器进程可同时为多个客户进程提供服务。
  - 以用户权限管理的方式提供用户对远程FTP服务器上的文件管理能力。
  - 以匿名FTP的方式提供公用文件共享的能力。
- **FTP工作原理**
  - FTP的服务器进程由两大部分组成:
    - 一个主进程，负责接收新的请求;
    - 若干从属进程，负责处理单个请求。
  - 程序流程：
    - 打开**熟知端口21 (控制端口)**，使客户进程能够连接上。
    - 等待客户进程发连接请求。
    - **启动从属进程来处理客户进程发来的请求**。主进程与从属进程并发执行，从属进程对客户进程的请求处理完毕后即终止。
    - 主进程回到等待状态，继续接收其他客户进程的请求。
  - FTP在工作时使用两个并行的TCP连接:
    - **控制连接(端口号21)**
      - FTP服务器 **监听21号端口**，等待客户连接，**建立在这个端口上的连接称为控制连接**。
      - 控制连接用来**传输控制信息**（如连接请求、传送请求等），并且控制信息都以7位ASCII格式传送。
      - 客户端发送传送请求，通过控制连接发送给服务端的控制进程。
      - 在传输文件时还可以使用控制连接（如客户在传输中途发一个中止传输的命令），因此**控制连接在整个会话期间一直保持打开状态**。
    - **数据连接(端口号20)**
      - 服务器端的控制进程在接收到FTP客户发来的文件传输请求后，就创建**数据传送进程**和**数据连接**。
      - 数据连接用来连接客户端和服务器端的数据传送进程，数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行。

### 6.4 电子邮件系统的组成和结构

#### 6.4.1 电子邮件的信息格式

- 电子邮件分为：
  - 信封
  - 内容
    - 首部：包含用户代理所需的控制信息。
    - 主体：用户自由撰写。
- RFC 5322 是 Internet 邮件格式的最新版本，最初的邮件格式由 RFC 822 描述。

#### 6.4.2 电子邮件系统的组成结构

- 一个 电子邮件系统应具有三个最主要的组成构件：
  - 用户代理(User Agent)
  - 邮件服务器/邮件传输代理（Message Transfer agent）
  - 电子邮件使用的协议，如SMTP、POP3 (或IMAP)等。

![](D:\学习\计算机网络\img\电子邮件系统的组成结构.png)

- **用户代理(UA)**：用户与电子邮件系统的接口。

  - 用户代理使用户能够通过一个很友好的接口发送和接收邮件，用户代理至少应当具有撰写、显示和邮件处理的功能。
  - 通常情况下，用户代理就是一个运行在PC上的程序，常见的有Outlook、Foxmail 和Thunderbird等。

- **邮件服务器**：组成电子邮件系统的核心。

  - 邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况(已交付、被拒绝、丢失等)。
  - 邮件服务器采用客户/服务器方式工作，但它能够同时充当客户和服务器。
  - 例如，当邮件服务器A向邮件服务器B发送邮件时，A就作为SMTP客户，而B是SMTP服务器；反之，当B向A发送邮件时，B就是SMTP客户，而A就是SMTP服务器。

- **邮件发送协议和读取协议**：

  - 邮件发送协议用于用户代理向邮件服务器发送邮件或在邮件服务器之间发送邮件，通常使用的是SMTP;
  - 邮件读取协议用于用户代理从邮件服务器读取邮件，如POP3。
  - SMTP采用的是“推”(Push)的通信方式，即在用户代理向邮件服务器发送邮件及在邮件服务器之间发送邮件时，SMTP 客户端主动将邮件“推”送到SMTP服务器端。
  - POP3采用的是“拉”(Pull)的通信方式，即用户读取邮件时，用户代理向邮件服务器发出请求，“拉”取用户邮箱中的邮件。

- **邮件发送过程**：

  - 用户在用户代理中写好一封邮件，使用**SMTP**将邮件从**发送方用户代理**发送到**发送方邮件服务器**。

  - **发送方邮件服务器**使用SMTP将邮件发送到**接收方邮件服务器**。

    - 为了确定接收方的邮件服务器，必须咨询DNS。DNS中每个域都有一组与它相关联的资源记录，其中包含了**MX（邮件交换），指定了愿意接受邮件的邮件服务器**。
    - 于是，**发送方邮件服务器**与**接收方邮件服务器IP地址的25号端口**建立一个**TCP连接**，使用SMTP来中继信息。
    - 最终接收方邮件服务器将邮件放置在收件人的邮件中。

    - 接收方用户代理向接收方邮件服务器发出请求，“拉”取用户邮箱中的邮件。
      - 可用协议：POP、IMAP。

#### 6.4.3 电子邮件协议

- **简单邮件传输协议（SMTP，Simple Mail Transfer Protocol）**：规定了在两个相互通信的SMTP进程之间如何交换信息。

  - 是一个**基于TCP协议**的**ASCII协议**，因此更加易于开发、测试和调试。

  - 采用客户端/服务器方式，负责发送邮件的SMTP进程就是SMTP客户，负责接收邮件的进程就是SMTP服务器。

  - SMTP不使用中间邮件服务器。

  - 优点：

    - 简单，易于开发、测试和调试。

  - 基本SMTP的缺陷：

    - 不包括认证。
    - 传输的是 ASCII 信息，而不是二进制数据，因此带宽使用效率低下，并且不能传送其他非英语国家的文字。
    - 内容为明文，没有任何加密功能已防止窥探隐私。

  - **ESMTP（带扩展功能的SMTP，Extended SMTP）**

    - 支持认证功能。

  - SMTP通信三个阶段

    - 连接建立
      - 发件人的邮件发送到发送方邮件服务器的邮件缓存中后，SMTP客户就每隔一定时间对邮件缓存扫描一次。
      - 如发现有邮件，就使用SMTP的**熟知端口号(25)** 与接收方邮件服务器的SMTP服务器建立TCP连接。
      - 连接建立后，接收方SMTP服务器发出220 Service ready (服务就绪)。
      - SMTP客户向SMTP服务器发送**HELO命令**，附上发送方的主机名。

    - 邮件传送
      - 邮件的传送从MAIL命令开始，MAIL 命令后面有发件人的地址。格式为 MAIL FROM: <发送方地址>。
      - 若SMTP服务器已准备好接收邮件，则回答250 OK。
      - 接着SMTP客户端发送一个或多个 RCPT 命令，格式为RCPT TO: <收件人地址>。
      - 每发送一个 RCPT命令，都应有相应的信息从SMTP服务器返回，如250 OK或550 No such user here (无此用户)。
      - 客户端就使用DATA命令，表示要开始传输邮件的内容。
      - 正常情况下，SMTP服务器回复信息是354 Start mail input; end with . 。表示回车换行。此时SMTP客户端就可开始传送邮件内容，并用. （两个回车，中间一个点）表示邮件内容的结束。
    - 连接释放
      - 邮件发送完毕后，SMTP客户应发送QUIT命令。
      - SMTP服务器返回的信息是221 (服务关闭)，表示SMTP同意释放TCP连接。邮件传送的全部过程就此结束。

  ```
  C: telent SMTP.163.com 25  //以telenet方式连接163邮件服务器  
  S: 220 163.com Anti-spam GT for Coremail System //220为响应数字，其后的为欢迎信息  
  C: HELO SMTP.163.com //除了HELO所具有的功能外，EHLO主要用来查询服务器支持的扩充功能   
  S: 250-mail  
  C: MAIL FROM: bripengandre@163.com  //发送者邮箱
  S: 250 … .  //“…”代表省略了一些可读信息  
  C: RCPT TO: bripengandre@smail.hust.edu.cn　//接收者邮箱  
  S: 250 … .    // “…”代表省略了一些可读信息  
  C: DATA //请求发送数据  
  S: 354 Enter mail, end with "." on a line by itself  
  C: Enjoy Protocol Studing  
  C: .  
  S: 250 Message sent  
  C: QUIT //退出连接   
  S: 221 Bye  
  ```

- **MIME—多用途网络邮件扩充**
  - 动机：由于SMTP只能传送一定长度的ASCII码，许多其他非英语国家的文字(如中文、俄文，甚至带重音符号的法文或德文)就无法传送，且无法传送可执行文件及其他二进制对象，因此提出了**多用途网络邮件扩充(Multipurpose Internet MailExtensions，MIME)**。
  - MIME并未改动SMTP或取代它。MIME的意图是继续使用目前的格式，但增加了邮件主体的结构，并定义了传送非ASCII码的编码规则。也就是说，MIME邮件可在现有的电子邮件程序和协议下传送。
  - **MIME主要包括以下三部分内容:**
    - 5个新的邮件首部字段，包括MIME版本、内容 描述、内容标识、内容传送编码和内容类型。
    - 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。
    - 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。

- **邮局协议版本3（POP3，Post Office Protocol, version 3）**
  - POP 是一个非常简单但功能有限的邮件读取协议，现在使用的是它的第3个版本 POP3，由 RFC1939 说明。
  - POP3 采用的是“拉”(Pull)的通信方式，当用户读取邮件时，用户代理向邮件服务器发出请求，“拉”取用户邮箱中的邮件。
  - POP也使用**客户/服务器**的工作方式，**基于TCP协议**。
  - 接收方的用户代理上必须运行POP客户程序，而接收方的邮件服务器上则运行POP服务器程序，负责监听端口110。
  - POP有两种工作方式:“下载并保留”和“下载并删除”。
    - 在“下载并保留”方式下，用户从邮件服务器上读取邮件后，邮件依然会保存在邮件服务器上，用户可再次从服务器上读取该邮件;
    - 使用“下载并删除”方式时，邮件一旦被读取，就从邮件服务器上删除，用户不能再次从服务器上读取。

- **IMAP—因特网邮件访问协议（IMAP，Internet Message Access Protocol）**
  - 另一个邮件接收协议是IMAP，它比POP复杂得多。
  - IMAP也使用**客户/服务器**的工作方式，基于TCP协议，RFC3501 定义了 IMAP4。
  - 接收方的用户代理上必须运行 IMAP 客户程序，而接收方的邮件服务器上则运行 IMAP 服务器程序，负责监听端口143。
  - IMAP为用户提供了创建文件夹、在不同文件夹之间移动邮件及在远程文件夹中查询邮件的命令，为此IMAP服务器维护了会话用户的状态信息。
  - IMAP的另一特性是允许用户代理只获取报文的某些部分，例如可以只读取一个报文的首部，或一个多部分MIME报文的一部分。这非常适用于低带宽的情况，用户可能并不想取回邮箱中的所有邮件，尤其是包含很多音频或视频的大邮件。

- **万维网的电子邮件（Webmail）**
  - 随着万维网的流行，目前出现了很多基于万维网的电子邮件，如Hotmail、Gmail 等。
  - 这种电子邮件的特点是，用户浏览器与Hotmail或Gmail的邮件服务器之间的邮件发送或接收使用的是HTTP，而仅在不同邮件服务器之间传送邮件时才使用SMTP.



### 6.5 万维网与HTTP

#### 6.5.1 万维网（WWW，World Wide Web）

- 万维网(World Wide Web, WWW)是一个资料空间，在这个空间中：
  - 事物称为“资源”，并由一个全域“统一资源定位符”(URL)标识。
  - 这些资源通过超文本传输协议(HTTP)传送给使用者，通过单击链接来获取资源。
- 万维网以客户/服务器方式工作。
- 浏览器是在用户计算机上的万维网客户程序，而万维网文档所驻留的计算机则运行服务器程序，这台计算机称万维网服务器。

- **万维网的组成**：万维网的内核部分是由三个标准构成的：
  - 统一资源定位符(URL)。 负责标识万维网上的各种文档，并使每个文档在整个万维网的范围内具有唯一的标识符URL。
    - URL是对可以从因特网上得到的资源的位置和访问方法的一种简洁表示。URL相当于一个文件名在网络范围的扩展。
    - URL的一般形式是: <协议>://<主机>:<端口>/<路径>。
      - 常见的<协议>有 http、ftp 等;
      - < (主机>是存放资源的主机在因特网中的域名，也可以是IP地址;
      - <端口>和<路径>有时可以省略。
    - 在URL中不区分大小写。
  - **超文本传输协议(HTTP)。 一个应用层协议，它使用TCP连接进行可靠的传输，HTTP是万维网客户程序和服务器程序之间交互所必须严格遵守的协议**。
  - 超文本标记语言(HTML)。 一种文档结构的标记语言，它使用一些约定的标记对页面上的各种信息(包括文字、声音、图像、视频等)、格式进行描述。
- 万维网工作流程，以http://www.baidu.com/index.html为例：
  - 浏览器分析链接指向页面的URL
  - 浏览器根据域名请求DNS查询Web服务器的IP地址。
  - DNS返回Web服务器的IP地址。
  - 浏览器与对应IP的80端口建立一个TCP连接，80端口是HTTP协议的知名端口。
  - 浏览器发送.HTTP请求报文：GET /index.html。
  - Web服务器返回页面作为HTTP响应，例如发送文件/index.html。
  - 如果该页面包含需要显式的URL，那么浏览器经过同样的处理获取其他URL。
  - 浏览器显示页面/index.html。
  - 如果短期内没有向同一个服务器发出其他请求，那么释放TCP连接。

#### 6.5.2 HTTP—超文本传输协议

- HTTP定义了浏览器(万维网客户进程)怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。
- 从层次的角度看，**HTTP是面向事务的(Transaction-oriented) 应用层协议**，它**规定了在浏览器和服务器之间的请求和响应的格式与规则**，是万维网上能够可靠地交换文件(包括文本、声音、图像等各种多媒体文件)的重要基础。
- HTTP有两类报文:
  - 请求报文(从Web客户端向Web服务器发送服务请求)
  - 响应报文(从Web服务器对Web客户端请求的回答)。

- 特点：

  - http协议支持客户端/服务端模式，也是一种请求/响应模式的协议。
  - **HTTP采用TCP作为传输层协议**，保证了数据的可靠传输。
  - **HTTP是无状态的**。也就是说，同一个客户第二次访问同一个服务器上的页面时，服务器的响应与第一次被访问时的相同。
    - HTTP的无状态特性简化了服务器的设计，使服务器更容易支持大量并发的HTTP请求。
    - 在实际应用中，通常使用 Cookie 加数据库的方式来跟踪用户的活动。
  - **HTTP本身是无连接的**。也就是说，虽然HTTP使用了TCP连接，但通信的双方在交换HTTP报文之前不需要先建立HTTP连接。
  - 灵活：HTTP允许传输任意类型的数据对象。传输的类型由Content-Type加以标记。

- HTTP1.1的诞生，使得HTTP支持持续连接、流水线发送请求。

  - 对于**非持久连接**，每个网页元素对象(如JPEG图形、Flash 等)的传输都需要单独建立一个TCP连接。
  - **持久连接**，是指万维网服务器在发送响应后仍然保持这条连接，使同一个客户和服务器可以继续在这条连接上传送后续的HTTP请求与响应报文。
  - 持久连接又分为**非流水线**和**流水线**两种方式。
    - 对于非流水线方式，客户在收到前一个响应后才能发出下一个请求。
    - HTTP/1.1 的默认方式是使用流水线的持久连接。这种情况下，客户每遇到一个对象引用就立即发出一个请求，因而客户可以逐个地连续发出对各个引用对象的请求。

- **HTTP报文结构**

  - HTTP是面向文本的(Text-Oriented)， 因此报文中的每个字段都是一一些ASCII码串，并且每个字段的长度都是不确定的。
  - 有两类HTTP报文：
    - 请求报文: 从客户向服务器发送的请求报文
    - 响应报文: 从服务器到客户的回答

  ![](D:\学习\计算机网络\img\HTTP报文结构.png)

  - HTTP请求报文和响应报文都由三个部分组成：
    - **开始行**：用于区分是请求报文还是响应报文。
      - 在请求报文中的开始行称为**请求行**；
        - 包括方法、请求资源的URL、HTTP的版本。
      - 响应报文中的开始行称为**状态行**；
        - 包括版本、状态码、短语。
      - 开始行的三个字段之间都以空格分隔，最后的“CR"和“LF”分别代表“回车”和“换行”。
    - **消息头/首部行**：用来说明浏览器、服务器或报文主体的一些信息。
      - 请求报文中的消息头称为**请求头**，响应报文中的消息头称为**响应头**。
      - 首部可有几行，但可不使用。
      - 在每个首部行都有首部字段名和它的值，每行在结束的地方都要有“回车”和"换行”。
      - 整个首部结束时，还有一空行将首部行和后面的实体主体分开。
    - 实体主体：在请求报文中一般不用这个字段，而在响应报文中也可能没有这个字段。

  - 方法的种类：

    | 方法    | 描述                | 示例                  |
    | ------- | ------------------- | --------------------- |
    | GET     | 读取一个Web页面     | GET filename HTTP/1.1 |
    | HEAD    | 读取一个Web页面的头 |                       |
    | POST    | 附加一个Web页面     |                       |
    | PUT     | 存储一个Web页面     |                       |
    | DELETE  | 删除一个Web页面     |                       |
    | TRACE   | 回应入境请求        |                       |
    | CONNECT | 通过代理连接        |                       |
    | OPTIONS | 一个页面的查询选项  |                       |

- 请求方法：

  - GET:请求指定的页面信息，并返回实体主体。
  - POST:向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改。
  - HEAD:类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头
  - PUT:从客户端向服务器传送的数据取代指定的文档的内容。
  - DELETE:请求服务器删除指定的页面。

- **post和get的区别：**

  - 都包含请求头、请求行，post多了请求body。
  - get多用来查询，请求参数放在url中，不会对服务器上的内容产生作用。post用来提交，如把账号密码放入body中。
  - GET是直接添加到URL后面的，直接就可以在URL中看到内容，而POST是放在报文内部的，用户无法直接看到。
  - GET提交的数据长度是有限制的，因为URL长度有限制，具体的长度限制视浏览器而定。而POST没有。

- **响应状态码**

  - 200 OK - 客户端请求成功
  - 301 - 资源（网页等）被永久转移到其它URL
  - 302 - 临时跳转
  - 400 Bad Request - 客户端请求有语法错误，不能被服务器所理解
  - 401 Unauthorized - 请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用
  - 404 - 请求资源不存在，可能是输入了错误的URL
  - 500 - 服务器内部发生了不可预期的错误
  - 503 Server Unavailable - 服务器当前不能处理客户端的请求，一段时间后可能恢复正常。

- 请求报文抓包：

![](D:\学习\计算机网络\img\http请求报文抓包.png)

- 响应报文抓包：

![](D:\学习\计算机网络\img\http响应报文抓包.png)

- **一般http中存在如下问题：**
  - 请求信息明文传输，容易被窃听截取。
  - 数据的完整性未校验，容易被篡改
  - 没有验证对方身份，存在冒充危险

#### 6.5.3 HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）

- 为了解决上述HTTP存在的问题，就用到了HTTPS。

- HTTPS 协议：一般理解为HTTP+SSL/TLS，通过 SSL 证书来验证服务器的身份，并为浏览器和服务器之间的通信进行加密。

![](D:\学习\计算机网络\img\https.jpg)

- **HTTPS的缺点**
  - HTTPS协议多次握手，导致页面的加载时间延长近50%；
  - HTTPS连接缓存不如HTTP高效，会增加数据开销和功耗；
  - 申请SSL证书需要钱，功能越强大的证书费用越高。
  - SSL涉及到的安全算法会消耗 CPU 资源，对服务器资源消耗较大。

- **总结HTTPS和HTTP的区别**
  - HTTPS是HTTP协议的安全版本，HTTP协议的数据传输是明文的，是不安全的，HTTPS使用了SSL/TLS协议进行了加密处理。
  - http和https使用连接方式不同，默认端口也不一样，http是80，https是443。

## 补充7 TCP/IP 协议

### 7.1 TCP/IP 基础

![](D:\学习\计算机网络\img\TCP-IP 协议群.jpg)

- TCP/IP 的具体含义
  - 利用 IP 进行通信时所必须用到的协议群的统称。
- **数据处理流程**

![](D:\学习\计算机网络\img\数据处理流程.jpg)

- 传输层中的 TCP 和 UDP
  - TCP 是面向连接的、可靠的流协议。
    - TCP 用于在传输层有必要实现可靠传输的情况
  - UDP 是不具有可靠性的数据报协议。
    - UDP 主要用于那些对高速传输和实时性有较高要求的通信或广播通信。



## 附录 计算机网络设备

- **冲突域**：同一时间只能有一台设备发送信息的范围。共享式网络中，不同的主机同时发送数据时，就会产生信号冲突的问题，这时的共享网络就是一个**冲突域**。
- **广播域**：站点发出一个广播信号后能接收到这个信号的范围。通常来说一个局域网就是一个广播域。















